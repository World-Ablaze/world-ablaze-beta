############################################################################################################
#	Expert AI mod - MAP effects for World Ablaze
#	Province neighbor lookup and railway connections support
############################################################################################################

WA_AI_MAP_startup = {

	# Initialize province terrain types for pathfinding
	set_variable = { global.WA_AI_MAP_PROV_TYPE_plains = 1 }
	set_variable = { global.WA_AI_MAP_PROV_TYPE_desert = 2 }
	set_variable = { global.WA_AI_MAP_PROV_TYPE_marsh = 3 }
	set_variable = { global.WA_AI_MAP_PROV_TYPE_jungle = 4 }
	set_variable = { global.WA_AI_MAP_PROV_TYPE_forest = 5 }
	set_variable = { global.WA_AI_MAP_PROV_TYPE_urban = 6 }
	set_variable = { global.WA_AI_MAP_PROV_TYPE_hills = 7 }
	set_variable = { global.WA_AI_MAP_PROV_TYPE_mountain = 8 }
	set_variable = { global.WA_AI_MAP_PROV_TYPE_ocean = 9 }

	# Set up land types array for filtering
	add_to_array = { global.WA_AI_MAP_PROV_LAND_TYPES = global.WA_AI_MAP_PROV_TYPE_plains }
	add_to_array = { global.WA_AI_MAP_PROV_LAND_TYPES = global.WA_AI_MAP_PROV_TYPE_desert }
	add_to_array = { global.WA_AI_MAP_PROV_LAND_TYPES = global.WA_AI_MAP_PROV_TYPE_marsh }
	add_to_array = { global.WA_AI_MAP_PROV_LAND_TYPES = global.WA_AI_MAP_PROV_TYPE_jungle }
	add_to_array = { global.WA_AI_MAP_PROV_LAND_TYPES = global.WA_AI_MAP_PROV_TYPE_forest }
	add_to_array = { global.WA_AI_MAP_PROV_LAND_TYPES = global.WA_AI_MAP_PROV_TYPE_urban }
	add_to_array = { global.WA_AI_MAP_PROV_LAND_TYPES = global.WA_AI_MAP_PROV_TYPE_hills }
	add_to_array = { global.WA_AI_MAP_PROV_LAND_TYPES = global.WA_AI_MAP_PROV_TYPE_mountain }

	# Initialize province terrain types for terrain-aware pathfinding
	WA_AI_MAP_set_province_terrain_type = yes

	# Initialize province connections from WA data
	WA_AI_MAP_set_province_connections = yes

	# Initialize state province mappings
	WA_AI_MAP_set_state_province_ids = yes

	# Initialize railway connections
	WA_AI_MAP_set_province_railway_connections = yes

	# Initialize province position coordinates for pathfinding distance calculations
	WA_AI_MAP_set_province_pos = yes
}

###

WA_AI_MAP_get_province_neighbors = { # _get_province_id_neighbors, _get_province_neighbors_TERRAIN_TYPES = LAND, province_neighbors_

	clear_temp_array = province_neighbors_
	meta_effect = {
		text = {
			for_each_loop = { array = global.WA_AI_MAP_province_connections_[x] index = pn_i value = pn_v break = pn_b

				if = {
					limit = {
						if = { limit = { check_variable = { _get_province_neighbors_TERRAIN_TYPES^num > 0 } }
							is_in_array = { _get_province_neighbors_TERRAIN_TYPES = global.WA_AI_MAP_province_terrain_type^pn_v }
						}
						else = {
							# Default: all land types are valid
							OR = {
								NOT = { check_variable = { global.WA_AI_MAP_province_terrain_type^pn_v = global.WA_AI_MAP_PROV_TYPE_ocean } }
								check_variable = { global.WA_AI_MAP_province_terrain_type^pn_v = 0 } # Unknown terrain defaults to valid
							}
						}
					}

					add_to_temp_array = { province_neighbors_ = pn_v }
				}
			}
		}
		x = "[?_get_province_id_neighbors]"
	}

	clear_temp_array = _get_province_neighbors_TERRAIN_TYPES
}

WA_AI_MAP_get_nearby_states = { # var:_state arr:nearby_states_

	clear_temp_array = nearby_states_
	var:_state = {
		every_neighbor_state = {
			if = { limit = { NOT = { is_in_array = { nearby_states_ = THIS.id } } } add_to_temp_array = { nearby_states_ = THIS.id } }
			every_neighbor_state = { limit = { NOT = { state = PREV } }
				if = { limit = { NOT = { is_in_array = { nearby_states_ = THIS.id } } } add_to_temp_array = { nearby_states_ = THIS.id } }
			}
		}
	}
}

###

WA_AI_MAP_set_state_province_ids = {
	# State-to-province mappings are now pre-generated in WA_AI_MAP_state_provinces.txt
	# This function calls the generated data to populate:
	# - global.WA_AI_MAP_state_province_ids@{state_id} = [province_ids]
	# - global.WA_AI_MAP_province_state_id^{province_id} = state_id
	WA_AI_MAP_set_state_province_ids_data = yes
}

# Note: WA_AI_MAP_set_province_railway_connections is defined in WA_AI_MAP_province_railway_connections.txt
# That generated file contains all initial railway connection data from map/railways.txt
