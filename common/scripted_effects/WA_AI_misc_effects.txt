############################################################################################################
#	World Ablaze AI mod - misc effects  - WA CONVERSION DONE - PIERCING ANALYSIS AND STOCKPILE NOT RETAINED
############################################################################################################

###

### simulate naval training for xp (game AI never training its navy workaround)

WA_AI_train_navy = {

	@TRAINING_AVG_FUEL_CONSUMED_PER_SHIP = 32
	@TRAINING_AVG_XP_GAINED_PER_SHIP = 0.004

	set_temp_variable = { fuel_consumed = @TRAINING_AVG_FUEL_CONSUMED_PER_SHIP }
	multiply_temp_variable = { fuel_consumed = num_ships }
	multiply_temp_variable = { fuel_consumed = -1 }
	add_fuel = fuel_consumed

	set_temp_variable = { xp_gained = @TRAINING_AVG_XP_GAINED_PER_SHIP }
	multiply_temp_variable = { xp_gained = num_ships }
	navy_experience = xp_gained
}

WA_AI_calc_air_force_sizes = {

	### allied air size

	set_temp_variable = { friendly_air_force_size = num_deployed_planes }
	add_to_temp_variable = { friendly_air_force_size = num_equipment@small_fighter_airframe }

	for_each_scope_loop = { array = allies

		set_temp_variable = { friendly_air_force_size = num_deployed_planes }
		add_to_temp_variable = { friendly_air_force_size = num_equipment@small_fighter_airframe }
	}

	### enemies air size

	every_enemy_country = {

		set_temp_variable = { air_force_size_@THIS = num_deployed_planes }
		add_to_temp_variable = { air_force_size_@THIS = num_equipment@small_fighter_airframe }

		if = { limit = { is_in_faction = yes NOT = { is_faction_leader = yes } }

			var:faction_leader = {

				add_to_temp_variable = { faction_air_force_size_@THIS = air_force_size_@PREV }
			}
		}
		else_if = { limit = { is_faction_leader = yes }

			add_to_temp_variable = { faction_air_force_size_@THIS = air_force_size_@THIS }
			add_to_temp_array = { enemy_air_force_sizes = THIS.id }
		}
		else = { add_to_temp_array = { enemy_air_force_sizes = THIS.id } }
	}
}

WA_AI_stop_air_production_strategy = {

	if = {
		limit = {
			has_war = yes
			has_capitulated = no
		}

		### abandon air production if overwhelmed by enemy air

		if = {
			limit = {
				has_war = yes
				NOT = { has_country_flag = WA_AI_stop_air_production }
				surrender_progress > 0.3
				is_major = no
				has_deployed_air_force_size = { size < 300 type = fighter }
			}

			WA_AI_calc_air_force_sizes =  yes

			### compare

			for_each_scope_loop = { array = enemy_air_force_sizes

				if = { limit = { is_faction_leader = yes }

					if = { limit = { check_variable = { faction_air_force_size_@THIS > 800 } }

						set_temp_variable = { air_force_size_ratio = friendly_air_force_size }
						divide_temp_variable = { air_force_size_ratio = faction_air_force_size_@THIS }

						if = { limit = { check_variable = { air_force_size_ratio < 0.25 } }

							ROOT = {
								set_country_flag = WA_AI_stop_air_production
								set_country_flag = { flag = WA_AI_stop_air_production_min_duration value = 1 days = 365 }
								set_country_flag = WA_AI_anti_air_design_focus
								clear_variable = WA_AI_no_surrender_progression_months

								if = { limit = { has_country_flag = WA_AI_logging } log = "[GetYear] [GetMonth] | AI | [Root.GetName] | AIR PRODUCTION: stopping air production" }
							}
						}
					}
				}
				else = {

					if = { limit = { check_variable = { air_force_size_@THIS > 200 } }

						set_temp_variable = { air_force_size_ratio = friendly_air_force_size }
						divide_temp_variable = { air_force_size_ratio = air_force_size_@THIS }

						if = { limit = { check_variable = { air_force_size_ratio < 0.25 } }

							ROOT = {
								set_country_flag = WA_AI_stop_air_production
								set_country_flag = { flag = WA_AI_stop_air_production_min_duration value = 1 days = 365 }
								set_country_flag = WA_AI_anti_air_design_focus
								clear_variable = WA_AI_no_surrender_progression_months

								if = { limit = { has_country_flag = WA_AI_logging } log = "[GetYear] [GetMonth] | AI | [Root.GetName] | AIR PRODUCTION: stopping air production" }
							}
						}
					}
				}
			}
		}

		### resume air production conditions

		else_if = {
			limit = {
				has_country_flag = WA_AI_stop_air_production
				NOT = { has_country_flag = WA_AI_stop_air_production_min_duration }
			}

			# track how long it has had no surrender progress (track change instead?)
			if = { limit = { NOT = { surrender_progress > 0.05 } }

				add_to_variable = { WA_AI_no_surrender_progression_months = 1 }
			}
			else = { clear_variable = WA_AI_no_surrender_progression_months }

			# is not losing anymore or has an airforce
			if = {
				limit = {
					OR = {
						check_variable = { WA_AI_no_surrender_progression_months > 5 }
						has_deployed_air_force_size = { size > 400 type = fighter }
					}
				}

				clr_country_flag = WA_AI_stop_air_production
				if = { limit = { has_country_flag = WA_AI_logging } log = "[GetYear] [GetMonth] | AI | [Root.GetName] | AIR PRODUCTION: restarting air production" }
			}

			# none of its enemies have a significant air force remaining
			else = {

				WA_AI_calc_air_force_sizes =  yes

				### compare

				for_each_scope_loop = { array = enemy_air_force_sizes

					if = { limit = { is_faction_leader = yes }

						if = { limit = { check_variable = { faction_air_force_size_@THIS > 800 } }

							set_temp_variable = { break = 1 }
						}
					}
					else = {

						if = { limit = { check_variable = { air_force_size_@THIS > 200 } }

							set_temp_variable = { break = 1 }
						}
					}
				}

				if = { limit = { check_variable = { break = 0 } }

					clr_country_flag = WA_AI_stop_air_production
					if = { limit = { has_country_flag = WA_AI_logging } log = "[GetYear] [GetMonth] | AI | [Root.GetName] | AIR PRODUCTION: restarting air production" }
				}
			}
		}
	}
	else = { clr_country_flag = WA_AI_stop_air_production }
}

WA_AI_defensive_front_strategy = {

	if = { limit = { has_war = yes }

		### critically low on equipment

		if = { limit = { check_variable = { WA_AI_fielded_eq_ratio < 0.6 } }

			if = { limit = { NOT = { has_country_flag = WA_AI_defensive_front_strategy } }

				log = "[GetYear] [GetMonth] | AI | [Root.GetName] | stopping attacks due to low equipment"
			}

			set_country_flag = WA_AI_defensive_front_strategy
		}
		else_if = {
			limit = {
				has_country_flag = WA_AI_defensive_front_strategy
				check_variable = { WA_AI_fielded_eq_ratio > 0.9 }
			}

			log = "[GetYear] [GetMonth] | AI | [Root.GetName] | CANCEL stopping attacks due to low equipment"

			clr_country_flag = WA_AI_defensive_front_strategy
		}

		### weak vs countries

		every_enemy_country = {

			if = {
				limit = {
					ROOT = {
						NOT = { is_in_array = { WA_AI_defensive_front_strategy_at = PREV.id } }

						alliance_strength_ratio < 0.5
						strength_ratio = { tag = PREV ratio < 0.25 }
					}
				}

				log = "[GetYear] [GetMonth] | AI | [Root.GetName] | stopping attacks vs [This.GetTag] (weak)"

				ROOT = { add_to_array = { WA_AI_defensive_front_strategy_at = PREV.id } }
			}
			else_if = {
				limit = {
					ROOT = {
						is_in_array = { WA_AI_defensive_front_strategy_at = PREV.id }

						NOT = {
							alliance_strength_ratio < 0.5
							strength_ratio = { tag = PREV ratio < 0.25 }
						}
					}
				}

				log = "[GetYear] [GetMonth] | AI | [Root.GetName] | CANCEL stopping attacks vs [This.GetTag] (weak)"

				ROOT = { remove_from_array = { WA_AI_defensive_front_strategy_at = PREV.id } }
			}
		}
	}
}

WA_AI_calculate_fielded_eq_ratio = {

	### only count equipment that has a major impact in combat

	set_temp_variable = { fielded_eq_ratio = num_equipment_in_armies_k@infantry_equipment }
	divide_temp_variable = { fielded_eq_ratio = num_target_equipment_in_armies_k@infantry_equipment }
	add_to_temp_variable = { tot_fielded_eq_ratio = fielded_eq_ratio }
	add_to_temp_variable = { equipment_count = 1 }

	if = { limit = { check_variable = { num_target_equipment_in_armies_k@heavy_infantry_equipment > 1 } }

		set_temp_variable = { fielded_eq_ratio = num_equipment_in_armies_k@heavy_infantry_equipment }
		divide_temp_variable = { fielded_eq_ratio = num_target_equipment_in_armies_k@heavy_infantry_equipment }
		add_to_temp_variable = { tot_fielded_eq_ratio = fielded_eq_ratio }
		add_to_temp_variable = { equipment_count = 1 }
	}

	if = { limit = { check_variable = { num_target_equipment_in_armies_k@artillery_equipment > 1 } }

		set_temp_variable = { fielded_eq_ratio = num_equipment_in_armies_k@artillery_equipment }
		divide_temp_variable = { fielded_eq_ratio = num_target_equipment_in_armies_k@artillery_equipment }
		add_to_temp_variable = { tot_fielded_eq_ratio = fielded_eq_ratio }
		add_to_temp_variable = { equipment_count = 1 }
	}

	###

	divide_temp_variable = { tot_fielded_eq_ratio = equipment_count }

	set_variable = { WA_AI_fielded_eq_ratio = tot_fielded_eq_ratio }
}

### resources

# major resource shortages in production lines
WA_AI_check_resource_shortages = {

	### ALUMINIUM

	if = {
		limit = {
			# there is a deficit
			check_variable = { resource@aluminium < 0 }

			# total needed for production
			set_temp_variable = { aluminium_needed = resource_consumed@aluminium }
			multiply_temp_variable = { aluminium_needed = -1 }
			add_to_temp_variable = { aluminium_needed = resource@aluminium }

			# need is at least this much
			check_variable = { aluminium_needed < -50 }

			# deficit is >5% of total need
			set_temp_variable = { aluminium_deficit = resource@aluminium }
			divide_temp_variable = { aluminium_deficit = aluminium_needed }
			check_variable = { aluminium_deficit > 0.05 }
		}

		add_to_variable = { WA_AI_aluminium_resource_shortage = 1 }
	}
	else = { subtract_from_variable = { WA_AI_aluminium_resource_shortage = 1 } }
	clamp_variable = { var = WA_AI_aluminium_resource_shortage min = 0 max = 3 }
	if = { limit = { has_country_flag = WA_AI_resources_logging check_variable = { WA_AI_aluminium_resource_shortage = 3 } } log = "[GetYear] [GetMonth] | AI | [Root.GetName] | RESOURCES: major ALUMINIUM shortage" }

	### RUBBER

	if = {
		limit = {
			# there is a deficit
			check_variable = { resource@rubber < 0 }

			# total needed for production
			set_temp_variable = { rubber_needed = resource_consumed@rubber }
			multiply_temp_variable = { rubber_needed = -1 }
			add_to_temp_variable = { rubber_needed = resource@rubber }

			# need is at least this much
			check_variable = { rubber_needed < -50 }

			# deficit is >5% of total need
			set_temp_variable = { rubber_deficit = resource@rubber }
			divide_temp_variable = { rubber_deficit = rubber_needed }
			check_variable = { rubber_deficit > 0.05 }
		}

		add_to_variable = { WA_AI_rubber_resource_shortage = 1 }
	}
	else = { subtract_from_variable = { WA_AI_rubber_resource_shortage = 1 } }
	clamp_variable = { var = WA_AI_rubber_resource_shortage min = 0 max = 3 }
	if = { limit = { has_country_flag = WA_AI_resources_logging check_variable = { WA_AI_rubber_resource_shortage = 3 } } log = "[GetYear] [GetMonth] | AI | [Root.GetName] | RESOURCES: major RUBBER shortage" }

	### TUNGSTEN

	if = {
		limit = {
			# there is a deficit
			check_variable = { resource@tungsten < 0 }

			# total needed for production
			set_temp_variable = { tungsten_needed = resource_consumed@tungsten }
			multiply_temp_variable = { tungsten_needed = -1 }
			add_to_temp_variable = { tungsten_needed = resource@tungsten }

			# need is at least this much
			check_variable = { tungsten_needed < -50 }

			# deficit is >5% of total need
			set_temp_variable = { tungsten_deficit = resource@tungsten }
			divide_temp_variable = { tungsten_deficit = tungsten_needed }
			check_variable = { tungsten_deficit > 0.05 }
		}

		add_to_variable = { WA_AI_tungsten_resource_shortage = 1 }
	}
	else = { subtract_from_variable = { WA_AI_tungsten_resource_shortage = 1 } }
	clamp_variable = { var = WA_AI_tungsten_resource_shortage min = 0 max = 3 }
	if = { limit = { has_country_flag = WA_AI_resources_logging check_variable = { WA_AI_tungsten_resource_shortage = 3 } } log = "[GetYear] [GetMonth] | AI | [Root.GetName] | RESOURCES: major TUNGSTEN shortage" }

	### STEEL

	if = {
		limit = {
			# there is a deficit
			check_variable = { resource@steel < 0 }

			# total needed for production
			set_temp_variable = { steel_needed = resource_consumed@steel }
			multiply_temp_variable = { steel_needed = -1 }
			add_to_temp_variable = { steel_needed = resource@steel }

			# need is at least this much
			check_variable = { steel_needed < -50 }

			# deficit is >5% of total need
			set_temp_variable = { steel_deficit = resource@steel }
			divide_temp_variable = { steel_deficit = steel_needed }
			check_variable = { steel_deficit > 0.05 }
		}

		add_to_variable = { WA_AI_steel_resource_shortage = 1 }
	}
	else = { subtract_from_variable = { WA_AI_steel_resource_shortage = 1 } }
	clamp_variable = { var = WA_AI_steel_resource_shortage min = 0 max = 3 }
	if = { limit = { has_country_flag = WA_AI_resources_logging check_variable = { WA_AI_steel_resource_shortage = 3 } } log = "[GetYear] [GetMonth] | AI | [Root.GetName] | RESOURCES: major STEEL shortage" }

	### CHROMIUM

	if = {
		limit = {
			# there is a deficit
			check_variable = { resource@chromium < 0 }

			# total needed for production
			set_temp_variable = { chromium_needed = resource_consumed@chromium }
			multiply_temp_variable = { chromium_needed = -1 }
			add_to_temp_variable = { chromium_needed = resource@chromium }

			# need is at least this much
			check_variable = { chromium_needed < -50 }

			# deficit is >5% of total need
			set_temp_variable = { chromium_deficit = resource@chromium }
			divide_temp_variable = { chromium_deficit = chromium_needed }
			check_variable = { chromium_deficit > 0.05 }
		}

		add_to_variable = { WA_AI_chromium_resource_shortage = 1 }
	}
	else = { subtract_from_variable = { WA_AI_chromium_resource_shortage = 1 } }
	clamp_variable = { var = WA_AI_chromium_resource_shortage min = 0 max = 3 }
	if = { limit = { has_country_flag = WA_AI_resources_logging check_variable = { WA_AI_chromium_resource_shortage = 3 } } log = "[GetYear] [GetMonth] | AI | [Root.GetName] | RESOURCES: major CHROMIUM shortage" }

	### COAL

	if = {
		limit = {
			# there is a deficit
			check_variable = { resource@coal < 0 }

			# total needed for production
			set_temp_variable = { coal_needed = resource_consumed@coal }
			multiply_temp_variable = { coal_needed = -1 }
			add_to_temp_variable = { coal_needed = resource@coal }

			# need is at least this much
			check_variable = { coal_needed < -50 }

			# deficit is >5% of total need
			set_temp_variable = { coal_deficit = resource@coal }
			divide_temp_variable = { coal_deficit = coal_needed }
			check_variable = { coal_deficit > 0.05 }
		}

		add_to_variable = { WA_AI_coal_resource_shortage = 1 }
	}
	else = { subtract_from_variable = { WA_AI_coal_resource_shortage = 1 } }
	clamp_variable = { var = WA_AI_coal_resource_shortage min = 0 max = 3 }
	if = { limit = { has_country_flag = WA_AI_resources_logging check_variable = { WA_AI_coal_resource_shortage = 3 } } log = "[GetYear] [GetMonth] | AI | [Root.GetName] | RESOURCES: major coal shortage" }

	### BAUXITE

	if = {
		limit = {
			# there is a deficit
			check_variable = { resource@bauxite < 0 }

			# total needed for production
			set_temp_variable = { bauxite_needed = resource_consumed@bauxite }
			multiply_temp_variable = { bauxite_needed = -1 }
			add_to_temp_variable = { bauxite_needed = resource@bauxite }

			# need is at least this much
			check_variable = { bauxite_needed < -50 }

			# deficit is >5% of total need
			set_temp_variable = { bauxite_deficit = resource@bauxite }
			divide_temp_variable = { bauxite_deficit = bauxite_needed }
			check_variable = { bauxite_deficit > 0.05 }
		}

		add_to_variable = { WA_AI_bauxite_resource_shortage = 1 }
	}
	else = { subtract_from_variable = { WA_AI_bauxite_resource_shortage = 1 } }
	clamp_variable = { var = WA_AI_bauxite_resource_shortage min = 0 max = 3 }
	if = { limit = { has_country_flag = WA_AI_resources_logging check_variable = { WA_AI_bauxite_resource_shortage = 3 } } log = "[GetYear] [GetMonth] | AI | [Root.GetName] | RESOURCES: major bauxite shortage" }

	### IRON

	if = {
		limit = {
			# there is a deficit
			check_variable = { resource@iron < 0 }

			# total needed for production
			set_temp_variable = { iron_needed = resource_consumed@iron }
			multiply_temp_variable = { iron_needed = -1 }
			add_to_temp_variable = { iron_needed = resource@iron }

			# need is at least this much
			check_variable = { iron_needed < -50 }

			# deficit is >5% of total need
			set_temp_variable = { iron_deficit = resource@iron }
			divide_temp_variable = { iron_deficit = iron_needed }
			check_variable = { iron_deficit > 0.05 }
		}

		add_to_variable = { WA_AI_iron_resource_shortage = 1 }
	}
	else = { subtract_from_variable = { WA_AI_iron_resource_shortage = 1 } }
	clamp_variable = { var = WA_AI_iron_resource_shortage min = 0 max = 3 }
	if = { limit = { has_country_flag = WA_AI_resources_logging check_variable = { WA_AI_iron_resource_shortage = 3 } } log = "[GetYear] [GetMonth] | AI | [Root.GetName] | RESOURCES: major iron shortage" }
}

# resource need based on deficits or imports
WA_AI_check_resource_needs = {

	### aluminium

	if = {
		limit = {
			OR = {
				check_variable = { resource@aluminium < -10 }
				check_variable = { resource_imported@aluminium > 10 }
			}
		}

		add_to_variable = { WA_AI_needs_aluminium = 1 }
	}
	else = { subtract_from_variable = { WA_AI_needs_aluminium = 1 } }
	clamp_variable = { var = WA_AI_needs_aluminium min = 0 max = 3 }
	if = { limit = { has_country_flag = WA_AI_resources_logging check_variable = { WA_AI_needs_aluminium = 3 } } log = "[GetYear] [GetMonth] | AI | [Root.GetName] | RESOURCES: needs ALUMINIUM" }

	### rubber

	if = {
		limit = {
			OR = {
				check_variable = { resource@rubber < -10 }
				check_variable = { resource_imported@rubber > 10 }
			}
		}

		add_to_variable = { WA_AI_needs_rubber = 1 }
	}
	else = { subtract_from_variable = { WA_AI_needs_rubber = 1 } }
	clamp_variable = { var = WA_AI_needs_rubber min = 0 max = 3 }
	if = { limit = { has_country_flag = WA_AI_resources_logging check_variable = { WA_AI_needs_rubber = 3 } } log = "[GetYear] [GetMonth] | AI | [Root.GetName] | RESOURCES: needs RUBBER" }

	### steel

	if = {
		limit = {
			OR = {
				check_variable = { resource@steel < -15 }
				check_variable = { resource_imported@steel > 15 }
			}
		}

		add_to_variable = { WA_AI_needs_steel = 1 }
	}
	else = { subtract_from_variable = { WA_AI_needs_steel = 1 } }
	clamp_variable = { var = WA_AI_needs_steel min = 0 max = 3 }
	if = { limit = { has_country_flag = WA_AI_resources_logging check_variable = { WA_AI_needs_steel = 3 } } log = "[GetYear] [GetMonth] | AI | [Root.GetName] | RESOURCES: needs STEEL" }

	### tungsten

	if = {
		limit = {
			OR = {
				check_variable = { resource@tungsten < -15 }
				check_variable = { resource_imported@tungsten > 15 }
			}
		}

		add_to_variable = { WA_AI_needs_tungsten = 1 }
	}
	else = { subtract_from_variable = { WA_AI_needs_tungsten = 1 } }
	clamp_variable = { var = WA_AI_needs_tungsten min = 0 max = 3 }
	if = { limit = { has_country_flag = WA_AI_resources_logging check_variable = { WA_AI_needs_tungsten = 3 } } log = "[GetYear] [GetMonth] | AI | [Root.GetName] | RESOURCES: needs TUNGSTEN" }

	### chromium

	if = {
		limit = {
			OR = {
				check_variable = { resource@chromium < -15 }
				check_variable = { resource_imported@chromium > 15 }
			}
		}

		add_to_variable = { WA_AI_needs_chromium = 1 }
	}
	else = { subtract_from_variable = { WA_AI_needs_chromium = 1 } }
	clamp_variable = { var = WA_AI_needs_chromium min = 0 max = 3 }
	if = { limit = { has_country_flag = WA_AI_resources_logging check_variable = { WA_AI_needs_chromium = 3 } } log = "[GetYear] [GetMonth] | AI | [Root.GetName] | RESOURCES: needs CHROMIUM" }

	### coal

	if = {
		limit = {
			OR = {
				check_variable = { resource@coal < -40 }
				check_variable = { resource_imported@coal > 40 }
			}
		}

		add_to_variable = { WA_AI_needs_coal = 1 }
	}
	else = { subtract_from_variable = { WA_AI_needs_coal = 1 } }
	clamp_variable = { var = WA_AI_needs_coal min = 0 max = 3 }
	if = { limit = { has_country_flag = WA_AI_resources_logging check_variable = { WA_AI_needs_coal = 3 } } log = "[GetYear] [GetMonth] | AI | [Root.GetName] | RESOURCES: needs coal" }

	### bauxite

	if = {
		limit = {
			OR = {
				check_variable = { resource@bauxite < -25 }
				check_variable = { resource_imported@bauxite > 25 }
			}
		}

		add_to_variable = { WA_AI_needs_bauxite = 1 }
	}
	else = { subtract_from_variable = { WA_AI_needs_bauxite = 1 } }
	clamp_variable = { var = WA_AI_needs_bauxite min = 0 max = 3 }
	if = { limit = { has_country_flag = WA_AI_resources_logging check_variable = { WA_AI_needs_bauxite = 3 } } log = "[GetYear] [GetMonth] | AI | [Root.GetName] | RESOURCES: needs bauxite" }

	### iron

	if = {
		limit = {
			OR = {
				check_variable = { resource@iron < -25 }
				check_variable = { resource_imported@iron > 25 }
			}
		}

		add_to_variable = { WA_AI_needs_iron = 1 }
	}
	else = { subtract_from_variable = { WA_AI_needs_iron = 1 } }
	clamp_variable = { var = WA_AI_needs_iron min = 0 max = 3 }
	if = { limit = { has_country_flag = WA_AI_resources_logging check_variable = { WA_AI_needs_iron = 3 } } log = "[GetYear] [GetMonth] | AI | [Root.GetName] | RESOURCES: needs iron" }

	##################################################################################

	### allied resource needs

	for_each_scope_loop = { array = allies

		if = { limit = { check_variable = { resource@aluminium < -20 } } 	ROOT = { set_country_flag = { flag = WA_AI_allies_need_aluminium value = 1 days = 30 } } }
		if = { limit = { check_variable = { resource@rubber < -20 } } 		ROOT = { set_country_flag = { flag = WA_AI_allies_need_rubber value = 1 days = 30 } } }
		if = { limit = { check_variable = { resource@tungsten < -20 } } 	ROOT = { set_country_flag = { flag = WA_AI_allies_need_tungsten value = 1 days = 30 } } }
		if = { limit = { check_variable = { resource@steel < -20 } } 		ROOT = { set_country_flag = { flag = WA_AI_allies_need_steel value = 1 days = 30 } } }
		if = { limit = { check_variable = { resource@chromium < -20 } } 	ROOT = { set_country_flag = { flag = WA_AI_allies_need_chromium value = 1 days = 30 } } }
		if = { limit = { check_variable = { resource@coal < -20 } } 	    ROOT = { set_country_flag = { flag = WA_AI_allies_need_coal value = 1 days = 30 } } }
		if = { limit = { check_variable = { resource@bauxite < -20 } }   	ROOT = { set_country_flag = { flag = WA_AI_allies_need_bauxite value = 1 days = 30 } } }
		if = { limit = { check_variable = { resource@iron < -20 } }     	ROOT = { set_country_flag = { flag = WA_AI_allies_need_iron value = 1 days = 30 } } }
	}
}

WA_AI_calculate_fuel_need = {

	### air

	set_temp_variable = { air_force_size = num_deployed_planes }

	multiply_temp_variable = { air_force_size = 1.8 } # fuel consumption estimate

	### land

	set_temp_variable = { armor_size = 0 }

	set_temp_variable = { armor_size = num_battalions_with_type@medium_armor }
	add_to_temp_variable = { armor_size = num_battalions_with_type@medium_sp_anti_air_brigade }
	add_to_temp_variable = { armor_size = num_battalions_with_type@medium_sp_artillery_brigade }
	add_to_temp_variable = { armor_size = num_battalions_with_type@medium_tank_destroyer_brigade }

	add_to_temp_variable = { armor_size = num_battalions_with_type@heavy_armor }
	add_to_temp_variable = { armor_size = num_battalions_with_type@heavy_sp_anti_air_brigade }
	add_to_temp_variable = { armor_size = num_battalions_with_type@heavy_sp_artillery_brigade }
	add_to_temp_variable = { armor_size = num_battalions_with_type@heavy_tank_destroyer_brigade }

	add_to_temp_variable = { armor_size = num_battalions_with_type@modern_armor }
	add_to_temp_variable = { armor_size = num_battalions_with_type@modern_sp_anti_air_brigade }
	add_to_temp_variable = { armor_size = num_battalions_with_type@modern_sp_artillery_brigade }
	add_to_temp_variable = { armor_size = num_battalions_with_type@modern_tank_destroyer_brigade }

	add_to_temp_variable = { armor_size = num_battalions_with_type@light_armor }
	add_to_temp_variable = { armor_size = num_battalions_with_type@light_sp_anti_air_brigade }
	add_to_temp_variable = { armor_size = num_battalions_with_type@light_sp_artillery_brigade }
	add_to_temp_variable = { armor_size = num_battalions_with_type@light_tank_destroyer_brigade }

	multiply_temp_variable = { armor_size = 50 } # fuel consumption estimate

	### navy

	set_temp_variable = { navy_size = num_ships }

	multiply_temp_variable = { navy_size = 60 } # fuel consumption estimate

	### total

	set_variable = { WA_AI_max_fuel_consumption_estimate = air_force_size }
	add_to_variable = { WA_AI_max_fuel_consumption_estimate = armor_size }
	add_to_variable = { WA_AI_max_fuel_consumption_estimate = navy_size }
}


WA_AI_num_surface_ships = {

	set_variable = { WA_AI_num_surface_ships = num_ships_with_type@destroyer }
	add_to_variable = { WA_AI_num_surface_ships = num_ships_with_type@light_cruiser }
	add_to_variable = { WA_AI_num_surface_ships = num_ships_with_type@heavy_cruiser }
	add_to_variable = { WA_AI_num_surface_ships = num_ships_with_type@battle_cruiser }
	add_to_variable = { WA_AI_num_surface_ships = num_ships_with_type@battleship }
	add_to_variable = { WA_AI_num_surface_ships = num_ships_with_type@frigate }
}


# submarines lost during 20 days
WA_AI_track_submarine_losses = {

	set_temp_variable = {WA_total_subs = num_ships_with_type@submarine}
	add_to_temp_variable = {WA_total_subs = num_ships_with_type@cruiser_submarine}

	subtract_from_variable = { WA_AI_previous_subs = WA_total_subs }

	if = { limit = { check_variable = { WA_AI_previous_subs > 0 } }

		divide_variable = { WA_AI_previous_subs = WA_total_subs }
		if = { limit = { check_variable = { WA_AI_previous_subs > 0.05 } } # lost more than 5%
			set_country_flag = { flag = WA_AI_halt_sub_missions value = 1 days = 14 }
		}
	}

	set_variable = { WA_AI_previous_subs = WA_total_subs }
}

# track the max armor value seen from other countries and the max piercing value of this country
# WA_AI_armor_intel_check = {

# 	if = {
# 		limit = {
# 			OR = { # only check if it has a template that can upgrade its piercing
# 				has_country_flag = WA_AI_anti_tank_template_upgrade
# 				has_country_flag = WA_AI_marm_template_upgrade
# 				has_country_flag = WA_AI_harm_template_upgrade
# 			}
# 		}

# 		### armor intel from other countries

# 		# enemies + neighbors

# 		set_temp_variable = { armor_intel_value = WA_AI_max_armor_seen }

# 		while_loop_effect = { limit = { check_variable = { armor_intel_value < 200 } }

# 			if = {
# 				limit = {
# 					meta_trigger = {
# 						text = {
# 							NOT = {
# 								any_neighbor_country = {
# 									WA_AI_is_threat = yes
# 									ROOT = { estimated_intel_max_armor = { tag = PREV value > [x] } }
# 								}
# 								any_enemy_country = { ROOT = { estimated_intel_max_armor = { tag = PREV value > [x] } } }
# 							}
# 						}
# 						x = "[?armor_intel_value|.0]"
# 					}
# 				}

# 				if = { limit = { NOT = { check_variable = { WA_AI_max_armor_seen = armor_intel_value } } }

# 					if = { limit = { has_country_flag = WA_AI_logging } log = "[GetYear] [GetMonth] | AI | [Root.GetName] | ARMOR INTEL: new highest armor intel value = [?armor_intel_value]" }
# 				}

# 				set_variable = { WA_AI_max_armor_seen = armor_intel_value }
# 				set_temp_variable = { break = 1 }
# 			}

# 			add_to_temp_variable = { armor_intel_value = 5 }
# 		}

# 		# enemies only

# 		set_temp_variable = { armor_intel_value = WA_AI_max_armor_seen_enemies }

# 		while_loop_effect = { limit = { check_variable = { armor_intel_value < 200 } }

# 			if = {
# 				limit = {
# 					meta_trigger = {
# 						text = {
# 							NOT = {
# 								any_enemy_country = { ROOT = { estimated_intel_max_armor = { tag = PREV value > [x] } } }
# 							}
# 						}
# 						x = "[?armor_intel_value|.0]"
# 					}
# 				}

# 				if = { limit = { NOT = { check_variable = { WA_AI_max_armor_seen_enemies = armor_intel_value } } }

# 					if = { limit = { has_country_flag = WA_AI_logging } log = "[GetYear] [GetMonth] | AI | [Root.GetName] | ARMOR INTEL: new enemies highest armor intel value = [?armor_intel_value]" }
# 				}

# 				set_variable = { WA_AI_max_armor_seen_enemies = armor_intel_value }
# 				set_temp_variable = { break = 1 }
# 			}

# 			add_to_temp_variable = { armor_intel_value = 5 }
# 		}

# 		### armor piercing of this country

# 		set_temp_variable = { piercing_value = WA_AI_max_piercing }

# 		while_loop_effect = { limit = { check_variable = { piercing_value < 200 } }

# 			if = {
# 				limit = {
# 					meta_trigger = {
# 						text = {
# 							NOT = { ROOT = { estimated_intel_max_piercing = { tag = ROOT value > [x] } } }
# 						}
# 						x = "[?piercing_value|.0]"
# 					}
# 				}

# 				set_variable = { WA_AI_max_piercing = piercing_value }
# 				set_temp_variable = { break = 1 }
# 			}

# 			add_to_temp_variable = { piercing_value = 2 }
# 		}
# 	}
# }

