############################################################################################################
#	World Ablaze AI mod - Railway Construction Priority - Strategy Implementations
#	Land War, Overseas War, and Pre-War Preparation strategies
############################################################################################################

### Constants (file-scoped, must be redeclared)
@WA_AI_PC_railway_MAX_ROUTES_PER_ENEMY = 2
@WA_AI_PC_railway_PRIO_PREWAR = 5000

############################################################################################################
#	STRATEGY 1: LAND WAR
#	Build railways from capital to front-line states with supply hubs/naval bases
#	Now properly detects supply_node buildings and finds exact province ID
#	Uses has_railway_level to skip states that already have level 5 railways (including focus-built)
#	Only builds to frontlines where ROOT (or puppets) directly borders the enemy
############################################################################################################

WA_AI_PC_railway_STRATEGY_land_war = {

	if = { limit = { has_country_flag = WA_AI_construction_logging }
		set_temp_variable = { _log_cap_state = global.WA_AI_MAP_province_state_id^capital_province }
		var:_log_cap_state = { ROOT = { log = "[GetYear] [GetMonth] | AI | [Root.GetName] | RAILWAY LAND: STARTED route_start=[?capital_province] ([Prev.GetName]) landmass=[?capital_landmass]" } }
	}

	# Default route parameters (will be overridden for overseas targets)
	set_temp_variable = { default_route_start = capital_province }
	set_temp_variable = { default_route_level = 5 }
	set_temp_variable = { route_priority = _project_priority }
	set_temp_variable = { high_route_priority = route_priority }
	multiply_temp_variable = { high_route_priority = 1.1 }

	# Track if we've analyzed overseas supply chain for this landmass
	clear_temp_array = _analyzed_landmasses_

	### For each RELEVANT enemy we DIRECTLY border (not through allies), find frontline states with supply hubs
	### This prevents building railways to distant frontlines (e.g., Italy -> SOV through Germany)
	### Uses pre-filtered _relevant_enemies_ array to reduce iteration count

	for_each_scope_loop = { array = _relevant_enemies_
		set_temp_variable = { _current_enemy_tag = THIS }

		# Check if ROOT (or ROOT's puppets) directly borders this enemy
		ROOT = {
			set_temp_variable = { _enemy_tag = _current_enemy_tag }
			WA_AI_PC_railway_country_borders_enemy = yes
		}

		# Only process enemies we directly border
		if = {
			limit = { check_variable = { borders_enemy_ = 1 } }

			if = { limit = { has_country_flag = WA_AI_construction_logging }
				log = "[GetYear] [GetMonth] | AI | [Root.GetName] | RAILWAY LAND: processing enemy [?_current_enemy_tag.GetName]"
			}

			### Per-enemy route counter
			set_temp_variable = { _routes_for_this_enemy = 0 }

			# Find front line states with supply hubs that border THIS specific enemy
			ROOT = {
				every_controlled_state = {
					limit = {
						### Skip if we already have enough routes for this enemy
						check_variable = { _routes_for_this_enemy < @WA_AI_PC_railway_MAX_ROUTES_PER_ENEMY }
						# State borders this specific enemy (or enemy's puppets)
						any_neighbor_state = {
							OR = {
								is_controlled_by = var:_current_enemy_tag
								controller = { is_subject_of = var:_current_enemy_tag }
							}
						}
						# State has a supply hub (proper check)
						WA_AI_PC_state_has_supply_hub = yes
						# Skip states that already have level 5 railways (native check - includes focus/event built)
						NOT = { WA_AI_PC_state_has_railway_level_5 = yes }
					}

					if = { limit = { ROOT = { has_country_flag = WA_AI_construction_logging } }
						ROOT = { log = "[GetYear] [GetMonth] | AI | [Root.GetName] | RAILWAY LAND: frontline state [Prev.GetName] passed limit check" }
					}

					# Skip single-node states (only port, no supply hub to connect to)
					WA_AI_PC_state_is_single_node = yes
					if = {
						limit = { check_variable = { is_single_node_ = 0 } }


						# Find the exact province with the supply hub
						WA_AI_PC_railway_get_supply_hub_province = yes

						if = {
							limit = {
								check_variable = { supply_hub_province_ > 0 }
								NOT = { is_in_array = { railway_end_provinces_ = supply_hub_province_ } }
								# Verify we control the supply hub province (for contested states)
								ROOT = { controls_province = var:supply_hub_province_ }
							}

							if = { limit = { ROOT = { has_country_flag = WA_AI_construction_logging } }
								ROOT = { log = "[GetYear] [GetMonth] | AI | [Root.GetName] | RAILWAY LAND: [Prev.GetName] hub_prov=[?supply_hub_province_] ACCEPTED" }
							}

							# Get state ID using province mapping (THIS.id doesn't work reliably for states)
							set_temp_variable = { _first_prov_temp = global.WA_AI_MAP_state_province_ids@THIS^0 }
							set_temp_variable = { _target_state_id = global.WA_AI_MAP_province_state_id^_first_prov_temp }
							# Get target landmass
							set_temp_variable = { target_landmass = global.WA_AI_MAP_state_landmass^_target_state_id }

							# Determine route start and level based on landmass
							if = {
								limit = { check_variable = { target_landmass = capital_landmass } }
								# Same landmass: use capital as route start, full level 5
								set_temp_variable = { route_start = default_route_start }
								set_temp_variable = { route_level = default_route_level }
							}
							else = {
								# Different landmass: analyze overseas supply chain
								# Check if we've already analyzed this landmass
								set_temp_variable = { _already_analyzed = 0 }
								for_each_loop = { array = _analyzed_landmasses_ value = _analyzed_lm
									if = { limit = { check_variable = { _analyzed_lm = target_landmass } }
										set_temp_variable = { _already_analyzed = 1 }
									}
								}

								if = {
									limit = { check_variable = { _already_analyzed = 0 } }
									# First time seeing this landmass - analyze supply chain
									ROOT = { WA_AI_PC_analyze_overseas_supply_chain = yes }
									add_to_temp_array = { _analyzed_landmasses_ = target_landmass }

									# Store results for reuse
									set_temp_variable = { _cached_overseas_route_start^target_landmass = overseas_route_start_ }
									set_temp_variable = { _cached_overseas_max_level^target_landmass = overseas_max_railway_level_ }
									set_temp_variable = { _cached_overseas_port_state^target_landmass = overseas_receiving_port_state_ }

									# Queue port upgrade if it's the bottleneck
									if = {
										limit = {
											check_variable = { overseas_max_railway_level_ < 5 }
											check_variable = { overseas_receiving_port_state_ > 0 }
											NOT = { is_in_array = { railway_port_upgrades_ = overseas_receiving_port_state_ } }
										}
										add_to_temp_array = { railway_port_upgrades_ = overseas_receiving_port_state_ }
									}
								}

								# Use cached overseas supply chain results
								set_temp_variable = { route_start = _cached_overseas_route_start^target_landmass }
								set_temp_variable = { route_level = _cached_overseas_max_level^target_landmass }

							}

							# Only proceed if we have a valid route start
							if = {
								limit = { check_variable = { route_start > 0 } }

								### Check for existing project to this destination - skip pathfinding if found
								set_temp_variable = { _skip_pathfinding = 0 }
								for_each_loop = { array = ROOT.WA_AI_PC_queue value = _check_proj break = _found_existing
									if = {
										limit = {
											check_variable = { ROOT.WA_AI_PC_building_type^_check_proj = 13 } # railway
											check_variable = { ROOT.WA_AI_PC_target_province^_check_proj = supply_hub_province_ }
										}
										set_temp_variable = { _skip_pathfinding = 1 }
										set_temp_variable = { _found_existing = 1 }
									}
								}

								if = {
									limit = { check_variable = { _skip_pathfinding = 0 } }

									# Skip if start and end are the same province (already connected)
									if = {
										limit = { NOT = { check_variable = { route_start = supply_hub_province_ } } }

										# Validate land path exists from route start to this frontline
										set_temp_variable = { _pathfind_prov_start = route_start }
										set_temp_variable = { _pathfind_prov_end = supply_hub_province_ }
										set_temp_variable = { _pathfind_prov_type = 2 } # Rail networks - only ROOT-controlled provinces
										set_temp_variable = { _pathfind_prov_allow_partial = 1 } # Allow partial paths to frontier
										WA_AI_PATHFIND_PROV_get_path = yes

										if = {
											limit = { check_variable = { pathfind_prov_success_ > 0 } } # 1 = full path, 2 = partial
											add_to_temp_array = { railway_start_provinces_ = route_start }
											add_to_temp_array = { railway_end_provinces_ = supply_hub_province_ }
											add_to_temp_array = { railway_target_levels_ = route_level }
											add_to_temp_array = { railway_priorities_ = route_priority }
											add_to_temp_array = { railway_enemy_tags_ = _current_enemy_tag }

											### Increment per-enemy counter
											add_to_temp_variable = { _routes_for_this_enemy = 1 }
										}
									}
								}
							}
						}

						else = {
							# Log why state was skipped
							if = { limit = { ROOT = { has_country_flag = WA_AI_construction_logging } }
								if = { limit = { check_variable = { supply_hub_province_ = 0 } }
									ROOT = { log = "[GetYear] [GetMonth] | AI | [Root.GetName] | RAILWAY LAND: [Prev.GetName] SKIPPED - no supply hub province found" }
								}
								else_if = { limit = { is_in_array = { railway_end_provinces_ = supply_hub_province_ } }
									ROOT = { log = "[GetYear] [GetMonth] | AI | [Root.GetName] | RAILWAY LAND: [Prev.GetName] SKIPPED - already in targets" }
								}
								else = {
									ROOT = { log = "[GetYear] [GetMonth] | AI | [Root.GetName] | RAILWAY LAND: [Prev.GetName] hub_prov=[?supply_hub_province_] SKIPPED - province not controlled by ROOT" }
								}
							}
						}
					} # end else (not single-node)
				}
			}
		}
	}

	### Sort targets by enemy threat (highest threat enemy's targets first)
	if = { limit = { check_variable = { railway_end_provinces_^num > 1 } }
		WA_AI_PC_railway_score_and_sort_by_enemy_threat = yes
	}

	if = { limit = { has_country_flag = WA_AI_construction_logging }
		log = "[GetYear] [GetMonth] | AI | [Root.GetName] | RAILWAY LAND: COMPLETED - [?railway_end_provinces_^num] targets found"
	}
}

############################################################################################################
#	STRATEGY 2: OVERSEAS WAR
#	A) Build max railway + port to best home port (within 5 states of capital)
#	B) Build railways from beachhead port on enemy continent to front lines
############################################################################################################

WA_AI_PC_railway_STRATEGY_overseas_war = {

	if = { limit = { has_country_flag = WA_AI_construction_logging } log = "[GetYear] [GetMonth] | AI | [Root.GetName] | RAILWAY OVERSEAS: STARTED" }

	set_temp_variable = { route_level = 5 }
	set_temp_variable = { route_priority = _project_priority }

	### PART A: Home port infrastructure
	### Use the new helper to find best port
	WA_AI_PC_railway_find_best_home_port = yes

	if = { limit = { has_country_flag = WA_AI_construction_logging }
		log = "[GetYear] [GetMonth] | AI | [Root.GetName] | RAILWAY OVERSEAS: Part A - home port state=[?best_home_port_state_] level=[?best_home_port_level_]"
	}

	### Queue railway from capital to home port (if not capital itself)
	if = {
		limit = {
			check_variable = { best_home_port_state_ > 0 }
			NOT = { check_variable = { best_home_port_state_ = capital_state_id } }
		}
		add_to_temp_array = { railway_start_provinces_ = capital_province }
		add_to_temp_array = { railway_end_provinces_ = best_home_port_province_ }
		add_to_temp_array = { railway_target_levels_ = route_level }
		add_to_temp_array = { railway_priorities_ = route_priority }

		if = { limit = { has_country_flag = WA_AI_construction_logging }
			log = "[GetYear] [GetMonth] | AI | [Root.GetName] | RAILWAY OVERSEAS: Part A - queued capital->home_port route"
		}
	}

	### Fix 11: Always mark best port for upgrade (even if it's the capital)
	if = {
		limit = { check_variable = { best_home_port_state_ > 0 } }
		add_to_temp_array = { railway_port_upgrades_ = best_home_port_state_ }
	}

	### PART B: Beachhead expansion
	### For each overseas enemy, find our biggest port on their continent

	if = { limit = { has_country_flag = WA_AI_construction_logging }
		log = "[GetYear] [GetMonth] | AI | [Root.GetName] | RAILWAY OVERSEAS: Part B - beachhead expansion starting"
	}

	# Fix 8: Track processed continents to avoid duplicate beachhead work (UK vs Japan + Siam)
	clear_temp_array = _processed_continents_

	every_enemy_country = {
		set_temp_variable = { enemy_tag = THIS }

		# Check if this is an overseas enemy (no land border)
		set_temp_variable = { enemy_has_land_border = 0 }
		ROOT = {
			every_controlled_state = {
				limit = {
					any_neighbor_state = {
						OR = {
							is_controlled_by = var:enemy_tag
							controller = { is_subject_of = var:enemy_tag }
						}
					}
				}
				set_temp_variable = { enemy_has_land_border = 1 }
			}
		}

		ROOT = { if = { limit = { has_country_flag = WA_AI_construction_logging } log = "[GetYear] [GetMonth] | AI | [Root.GetName] | RAILWAY OVERSEAS: enemy [?enemy_tag.GetName] has_land_border=[?enemy_has_land_border]" } }

		if = {
			limit = { check_variable = { enemy_has_land_border = 0 } }

			# Get enemy capital continent using new helper
			capital_scope = {
				WA_AI_PC_railway_get_continent = yes
				set_temp_variable = { enemy_continent = continent_id_ }
				# Get state ID using province mapping (THIS.id doesn't work reliably for states)
				set_temp_variable = { _first_prov_temp = global.WA_AI_MAP_state_province_ids@THIS^0 }
				set_temp_variable = { enemy_capital_state_id = global.WA_AI_MAP_province_state_id^_first_prov_temp }
			}

			# Fix 8: Skip if we already processed a beachhead for this continent
			set_temp_variable = { _skip_continent = 0 }
			for_each_loop = { array = _processed_continents_ value = _proc_cont
				if = {
					limit = { check_variable = { _proc_cont = enemy_continent } }
					set_temp_variable = { _skip_continent = 1 }
				}
			}

			# Only process if continent not already handled
			if = {
				limit = { check_variable = { _skip_continent = 0 } }
				# Mark continent as processed
				add_to_temp_array = { _processed_continents_ = enemy_continent }
			}

			# Find our biggest port on that continent (only if continent not already processed)
			if = {
				limit = { check_variable = { _skip_continent = 0 } }

				set_temp_variable = { best_beachhead_state = 0 }
				set_temp_variable = { best_beachhead_port = 0 }
				set_temp_variable = { best_beachhead_province = 0 }

				ROOT = {
					every_controlled_state = {
						# Use new continent helper
						WA_AI_PC_railway_get_continent = yes

						if = {
							limit = {
								check_variable = { continent_id_ = enemy_continent }
								is_coastal = yes
							}
							# Get naval base province and level using helper (naval_base trigger returns 0 in this scope)
							WA_AI_PC_railway_get_naval_base_province = yes

							if = {
								limit = {
									check_variable = { naval_base_province_ > 0 }
									check_variable = { naval_base_level_ > best_beachhead_port }
								}
								# Get state ID using province mapping (THIS.id doesn't work reliably for states)
								set_temp_variable = { _first_prov_temp = global.WA_AI_MAP_state_province_ids@THIS^0 }
								set_temp_variable = { best_beachhead_state = global.WA_AI_MAP_province_state_id^_first_prov_temp }
								set_temp_variable = { best_beachhead_port = naval_base_level_ }
								set_temp_variable = { best_beachhead_province = naval_base_province_ }
							}
						}
					}
				}

				if = { limit = { has_country_flag = WA_AI_construction_logging }
					log = "[GetYear] [GetMonth] | AI | [Root.GetName] | RAILWAY OVERSEAS: continent=[?enemy_continent] beachhead_state=[?best_beachhead_state] port_level=[?best_beachhead_port]"
				}

			### Distance check: Beachhead must be within 15 states of enemy capital
			### This prevents selecting beachheads too far from the theater of war
			if = {
				limit = { check_variable = { best_beachhead_state > 0 } }

				# Get all states within 15 steps of enemy capital
				set_temp_variable = { _origin_state_id = enemy_capital_state_id }
				set_temp_variable = { _max_distance = 15 }
				ROOT = { WA_AI_PC_railway_get_states_within_distance = yes }

				# Check if beachhead is within range (include origin state itself)
				add_to_temp_array = { states_within_distance_ = enemy_capital_state_id }
				if = {
					limit = { NOT = { is_in_array = { states_within_distance_ = best_beachhead_state } } }
					# Beachhead too far from enemy capital - skip it
					set_temp_variable = { best_beachhead_state = 0 }

					if = { limit = { has_country_flag = WA_AI_construction_logging }
						log = "[GetYear] [GetMonth] | AI | [Root.GetName] | RAILWAY OVERSEAS: beachhead too far from enemy capital - SKIPPED"
					}
				}
			}

			### Validate beachhead has path to at least one frontline before building railways
			### This prevents useless beachheads like Hong Kong surrounded by enemy territory
			if = {
				limit = { check_variable = { best_beachhead_state > 0 } }

				set_temp_variable = { beachhead_valid_ = 0 }

				# Find any frontline supply hub on this continent and test pathfinding
				ROOT = {
					every_controlled_state = {
						# Use new continent helper
						WA_AI_PC_railway_get_continent = yes

						if = {
							limit = {
								check_variable = { continent_id_ = enemy_continent }
								# Borders enemy (or enemy's puppets)
								any_neighbor_state = {
									OR = {
										is_controlled_by = var:enemy_tag
										controller = { is_subject_of = var:enemy_tag }
									}
								}
								# Has supply hub
								WA_AI_PC_state_has_supply_hub = yes
								# Only test if not already validated (optimization)
								check_variable = { beachhead_valid_ = 0 }
							}

							# Get supply hub province for pathfinding test
							WA_AI_PC_railway_get_supply_hub_province = yes

							if = {
								limit = {
									check_variable = { supply_hub_province_ > 0 }
									# Verify we control the supply hub province (for contested states)
									ROOT = { controls_province = var:supply_hub_province_ }
								}

								# Skip if start and end are the same (beachhead is the supply hub)
								if = {
									limit = { check_variable = { best_beachhead_province = supply_hub_province_ } }
									ROOT = { set_temp_variable = { beachhead_valid_ = 1 } } # Trivially valid
								}
								else = {
									# Test pathfinding from beachhead to this frontline
									set_temp_variable = { _pathfind_prov_start = best_beachhead_province }
									set_temp_variable = { _pathfind_prov_end = supply_hub_province_ }
									set_temp_variable = { _pathfind_prov_type = 2 } # Fix 21: Rail networks - only ROOT-controlled provinces (not allied)
									WA_AI_PATHFIND_PROV_get_path = yes

									if = {
										limit = { check_variable = { pathfind_prov_success_ = 1 } }
										ROOT = { set_temp_variable = { beachhead_valid_ = 1 } }
									}
								}
							}
						}
					}
				}

				# If beachhead invalid (no path to any frontline), skip it
				if = {
					limit = { check_variable = { beachhead_valid_ = 0 } }
					set_temp_variable = { best_beachhead_state = 0 }

					if = { limit = { has_country_flag = WA_AI_construction_logging }
						log = "[GetYear] [GetMonth] | AI | [Root.GetName] | RAILWAY OVERSEAS: beachhead has no path to frontlines - INVALID"
					}
				}
				else = {
					if = { limit = { has_country_flag = WA_AI_construction_logging }
						log = "[GetYear] [GetMonth] | AI | [Root.GetName] | RAILWAY OVERSEAS: beachhead VALID - path to frontline exists"
					}
				}
			}

			### Build railways from beachhead to front lines on this continent
			if = {
				limit = { check_variable = { best_beachhead_state > 0 } }

				# Mark beachhead port for upgrade
				if = {
					limit = { NOT = { is_in_array = { railway_port_upgrades_ = best_beachhead_state } } }
					add_to_temp_array = { railway_port_upgrades_ = best_beachhead_state }
				}

				# Find front-line states on this continent with supply hubs
				ROOT = {
					every_controlled_state = {
						# Use new continent helper
						WA_AI_PC_railway_get_continent = yes

						if = {
							limit = {
								check_variable = { continent_id_ = enemy_continent }
								# Borders enemy (or enemy's puppets)
								any_neighbor_state = {
									OR = {
										is_controlled_by = var:enemy_tag
										controller = { is_subject_of = var:enemy_tag }
									}
								}
								# Has supply hub (proper check)
								WA_AI_PC_state_has_supply_hub = yes
								# Skip states that already have level 5 railways (native check - includes focus/event built)
								NOT = { WA_AI_PC_state_has_railway_level_5 = yes }
							}

							# Find the exact province with the supply hub
							WA_AI_PC_railway_get_supply_hub_province = yes

							if = {
								limit = {
									check_variable = { supply_hub_province_ > 0 }
									NOT = { is_in_array = { railway_end_provinces_ = supply_hub_province_ } }
									# Verify we control the supply hub province (for contested states)
									ROOT = { controls_province = var:supply_hub_province_ }
								}
								# Start from beachhead, not capital
								add_to_temp_array = { railway_start_provinces_ = best_beachhead_province }
								add_to_temp_array = { railway_end_provinces_ = supply_hub_province_ }
								add_to_temp_array = { railway_target_levels_ = route_level }
								add_to_temp_array = { railway_priorities_ = route_priority }

								ROOT = { if = { limit = { has_country_flag = WA_AI_construction_logging }
									log = "[GetYear] [GetMonth] | AI | [Root.GetName] | RAILWAY OVERSEAS: ADDED beachhead->[Prev.GetName] route"
								} }
							}
						}
					}
				}
			}
			} # End of _skip_continent = 0 check (Fix 8)
		}
	}

	if = { limit = { has_country_flag = WA_AI_construction_logging }
		log = "[GetYear] [GetMonth] | AI | [Root.GetName] | RAILWAY OVERSEAS: COMPLETED - [?railway_end_provinces_^num] targets found"
	}
}

############################################################################################################
#	STRATEGY 3: PRE-WAR PREPARATION
#	Build railways toward countries we're justifying against, have wargoals on, or have claims on
############################################################################################################

WA_AI_PC_railway_STRATEGY_prewar_preparation = {

	if = { limit = { has_country_flag = WA_AI_construction_logging }
		log = "[GetYear] [GetMonth] | AI | [Root.GetName] | RAILWAY PREWAR: STARTED"
	}

	# Default route parameters (may be overridden for overseas targets)
	set_temp_variable = { default_route_start = capital_province }
	set_temp_variable = { default_route_level = 3 }  # Lower level for preparation
	set_temp_variable = { route_priority = @WA_AI_PC_railway_PRIO_PREWAR }

	# Track analyzed landmasses for caching
	clear_temp_array = _analyzed_landmasses_prewar_

	### Find potential targets: countries we're justifying against, have wargoals on, or have claims on
	### Consolidated from triple loop to single loop with OR conditions
	clear_temp_array = _target_countries_

	every_country = {
		limit = {
			exists = yes
			NOT = { tag = ROOT }
			NOT = { is_in_faction_with = ROOT }
			NOT = { is_subject_of = ROOT }
			OR = {
				ROOT = { is_justifying_wargoal_against = PREV }
				ROOT = { has_wargoal_against = PREV }
				any_owned_state = { is_claimed_by = ROOT }
			}
		}
		add_to_temp_array = { _target_countries_ = THIS }
	}

	if = { limit = { has_country_flag = WA_AI_construction_logging }
		log = "[GetYear] [GetMonth] | AI | [Root.GetName] | RAILWAY PREWAR: found [?_target_countries_^num] target countries"
	}

	### For each target, check if land or overseas
	for_each_loop = { array = _target_countries_ value = _target_tag

		# Check for land border
		set_temp_variable = { target_has_land_border = 0 }
		every_controlled_state = {
			limit = {
				any_neighbor_state = {
					is_owned_by = var:_target_tag
				}
			}
			set_temp_variable = { target_has_land_border = 1 }
		}

		if = { limit = { has_country_flag = WA_AI_construction_logging }
			log = "[GetYear] [GetMonth] | AI | [Root.GetName] | RAILWAY PREWAR: target [?_target_tag.GetName] has_land_border=[?target_has_land_border]"
		}

		if = {
			limit = { check_variable = { target_has_land_border = 1 } }

			### LAND TARGET: Build to border states with supply hubs
			every_controlled_state = {
				limit = {
					any_neighbor_state = {
						is_owned_by = var:_target_tag
					}
					# Has supply hub (proper check)
					WA_AI_PC_state_has_supply_hub = yes
					# Skip states that already have level 3+ railways (native check - includes focus/event built)
					NOT = { WA_AI_PC_state_has_railway_level_3 = yes }
				}

				# Skip single-node states (only port, no supply hub to connect to)
				WA_AI_PC_state_is_single_node = yes
				if = {
					limit = { check_variable = { is_single_node_ = 0 } }

				# Find the exact province with the supply hub
				WA_AI_PC_railway_get_supply_hub_province = yes

				if = {
					limit = {
						check_variable = { supply_hub_province_ > 0 }
						NOT = { is_in_array = { railway_end_provinces_ = supply_hub_province_ } }
						# Verify we control the supply hub province (for contested states)
						ROOT = { controls_province = var:supply_hub_province_ }
					}

					# Get state ID using province mapping (THIS.id doesn't work reliably for states)
					set_temp_variable = { _first_prov_temp = global.WA_AI_MAP_state_province_ids@THIS^0 }
					set_temp_variable = { _this_state_id = global.WA_AI_MAP_province_state_id^_first_prov_temp }
					# Get target landmass for cross-landmass detection
					set_temp_variable = { target_landmass = global.WA_AI_MAP_state_landmass^_this_state_id }

					# Determine route start and level based on landmass
					if = {
						limit = { check_variable = { target_landmass = capital_landmass } }
						# Same landmass: use capital as route start
						set_temp_variable = { route_start = default_route_start }
						set_temp_variable = { route_level = default_route_level }
					}
					else = {
						# Different landmass: analyze overseas supply chain

						# Check if we've already analyzed this landmass
						set_temp_variable = { _already_analyzed_pw = 0 }
						for_each_loop = { array = _analyzed_landmasses_prewar_ value = _analyzed_lm_pw
							if = { limit = { check_variable = { _analyzed_lm_pw = target_landmass } }
								set_temp_variable = { _already_analyzed_pw = 1 }
							}
						}

						if = {
							limit = { check_variable = { _already_analyzed_pw = 0 } }
							# First time seeing this landmass - analyze supply chain
							ROOT = { WA_AI_PC_analyze_overseas_supply_chain = yes }
							add_to_temp_array = { _analyzed_landmasses_prewar_ = target_landmass }

							# Store results for reuse
							set_temp_variable = { _cached_pw_route_start^target_landmass = overseas_route_start_ }
							set_temp_variable = { _cached_pw_max_level^target_landmass = overseas_max_railway_level_ }
							set_temp_variable = { _cached_pw_port_state^target_landmass = overseas_receiving_port_state_ }

							# Queue port upgrade if needed
							if = {
								limit = {
									check_variable = { overseas_receiving_port_state_ > 0 }
									NOT = { is_in_array = { railway_port_upgrades_ = overseas_receiving_port_state_ } }
								}
								add_to_temp_array = { railway_port_upgrades_ = overseas_receiving_port_state_ }
							}
						}

						# Use cached results, capped at prewar level
						set_temp_variable = { route_start = _cached_pw_route_start^target_landmass }
						set_temp_variable = { route_level = _cached_pw_max_level^target_landmass }
						# Cap at default prewar level
						if = { limit = { check_variable = { route_level > default_route_level } }
							set_temp_variable = { route_level = default_route_level }
						}
					}

					# Only proceed if we have a valid route start
					if = {
						limit = { check_variable = { route_start > 0 } }

						# Skip if start and end are the same province (already connected)
						if = {
							limit = { NOT = { check_variable = { route_start = supply_hub_province_ } } }

							# Validate land path exists from route start to this frontline
							set_temp_variable = { _pathfind_prov_start = route_start }
							set_temp_variable = { _pathfind_prov_end = supply_hub_province_ }
							set_temp_variable = { _pathfind_prov_type = 2 } # Rail networks - only ROOT-controlled provinces
							set_temp_variable = { _pathfind_prov_allow_partial = 1 } # Allow partial paths to frontier
							WA_AI_PATHFIND_PROV_get_path = yes

							if = {
								limit = { check_variable = { pathfind_prov_success_ > 0 } } # 1 = full path, 2 = partial
								add_to_temp_array = { railway_start_provinces_ = route_start }
								add_to_temp_array = { railway_end_provinces_ = supply_hub_province_ }
								add_to_temp_array = { railway_target_levels_ = route_level }
								add_to_temp_array = { railway_priorities_ = route_priority }
							}
						}
					}
				}
				} # end if not single-node
			}
		}
		else_if = {
			# Fix 22: Only execute overseas logic if ROOT has coastal access
			# This prevents landlocked nations (e.g., Hungary) from trying to build port infrastructure
			# when they have claims on non-bordering countries (e.g., Romania via Fix 14)
			limit = { any_controlled_state = { is_coastal = yes } }

			### OVERSEAS TARGET: Upgrade home port infrastructure
			### Use the new helper
			WA_AI_PC_railway_find_best_home_port = yes

			if = {
				limit = {
					check_variable = { best_home_port_state_ > 0 }
					NOT = { check_variable = { best_home_port_state_ = capital_state_id } }
					NOT = { is_in_array = { railway_end_provinces_ = best_home_port_province_ } }
				}
				add_to_temp_array = { railway_start_provinces_ = capital_province }
				add_to_temp_array = { railway_end_provinces_ = best_home_port_province_ }
				add_to_temp_array = { railway_target_levels_ = route_level }
				add_to_temp_array = { railway_priorities_ = route_priority }

				if = {
					limit = { NOT = { is_in_array = { railway_port_upgrades_ = best_home_port_state_ } } }
					add_to_temp_array = { railway_port_upgrades_ = best_home_port_state_ }
				}

				if = { limit = { has_country_flag = WA_AI_construction_logging }
					log = "[GetYear] [GetMonth] | AI | [Root.GetName] | RAILWAY PREWAR: ADDED overseas home port route"
				}
			}
		}
	}

	if = { limit = { has_country_flag = WA_AI_construction_logging }
		log = "[GetYear] [GetMonth] | AI | [Root.GetName] | RAILWAY PREWAR: COMPLETED - [?railway_end_provinces_^num] targets found"
	}
}
