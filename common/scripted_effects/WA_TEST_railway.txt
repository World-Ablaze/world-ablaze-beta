############################################################################################################
#	World Ablaze - Railway AI Functional Test Suite
#	Test bed: Japan (JAP) - early war, island nation, multiple theatres, edge cases
#	8 tests covering land war, overseas, pre-war, queue integrity, primitives
############################################################################################################

### Test State Constants (must match framework)
@WA_TEST_NOT_LAUNCHED = 0
@WA_TEST_ONGOING = 1
@WA_TEST_PASSED = 2
@WA_TEST_FAILED = 3

############################################################################################################
#	SUITE RUNNER
#	Scopes to JAP, initializes, launches all tests, schedules checker
############################################################################################################

WA_TEST_railway_suite = {
	JAP = {
		log = "[GetYear] [GetMonth] | TEST | [This.GetName] | ================================================"
		log = "[GetYear] [GetMonth] | TEST | [This.GetName] | RAILWAY TEST SUITE: STARTING"
		log = "[GetYear] [GetMonth] | TEST | [This.GetName] | ================================================"

		# Register country in global registry
		WA_TEST_register_country = yes

		# Initialize framework (preserves PASSED tests)
		WA_TEST_init = yes

		# Enable debug logging so railway system produces detailed output
		set_country_flag = WA_AI_construction_logging

		# Set suite active flag
		set_country_flag = WA_TEST_suite_active

		# Force railway system to run on next weekly tick
		set_variable = { WA_AI_PC_railway_INTERVAL_counter = 0 }

		# Clear existing railway projects (type 13 only) to start fresh
		# Collect IDs first, then remove (avoid modifying array during iteration)
		clear_temp_array = _wt_remove_ids
		for_each_loop = { array = WA_AI_PC_queue value = _wt_proj
			if = {
				limit = { check_variable = { WA_AI_PC_building_type^_wt_proj = 13 } }
				add_to_temp_array = { _wt_remove_ids = _wt_proj }
			}
		}
		set_temp_variable = { _wt_clear_count = _wt_remove_ids^num }
		for_each_loop = { array = _wt_remove_ids value = _project_id
			WA_AI_PC_end_project_by_id = yes
		}

		log = "[GetYear] [GetMonth] | TEST | [This.GetName] | SUITE: Cleared [?_wt_clear_count] existing railway projects"

		# Launch all tests
		WA_TEST_railway_launch_all = yes

		# Schedule the first checker event (after the weekly tick fires)
		country_event = { id = wa_test.100 days = 7 }

		log = "[GetYear] [GetMonth] | TEST | [This.GetName] | SUITE: All tests launched, checker scheduled in 7 days"
		WA_TEST_log_summary = yes
	}
}

############################################################################################################
#	ORCHESTRATORS
############################################################################################################

WA_TEST_railway_launch_all = {
	WA_TEST_railway_001_launch = yes
	WA_TEST_railway_002_launch = yes
	WA_TEST_railway_003_launch = yes
	WA_TEST_railway_004_launch = yes
	WA_TEST_railway_005_launch = yes
	WA_TEST_railway_006_launch = yes
	WA_TEST_railway_007_launch = yes
	WA_TEST_railway_008_launch = yes
}

WA_TEST_railway_check_all = {
	log = "[GetYear] [GetMonth] | TEST | [This.GetName] | CHECK: Evaluating all ongoing tests"

	# Timeout checks first
	set_temp_variable = { _wt_test_id = 1 }
	WA_TEST_check_timeout = yes
	set_temp_variable = { _wt_test_id = 2 }
	WA_TEST_check_timeout = yes
	set_temp_variable = { _wt_test_id = 3 }
	WA_TEST_check_timeout = yes
	set_temp_variable = { _wt_test_id = 4 }
	WA_TEST_check_timeout = yes
	set_temp_variable = { _wt_test_id = 5 }
	WA_TEST_check_timeout = yes
	set_temp_variable = { _wt_test_id = 6 }
	WA_TEST_check_timeout = yes
	set_temp_variable = { _wt_test_id = 7 }
	WA_TEST_check_timeout = yes
	set_temp_variable = { _wt_test_id = 8 }
	WA_TEST_check_timeout = yes

	# Individual test checks (only evaluates tests still ONGOING)
	WA_TEST_railway_001_check = yes
	WA_TEST_railway_002_check = yes
	WA_TEST_railway_003_check = yes
	WA_TEST_railway_004_check = yes
	WA_TEST_railway_005_check = yes
	WA_TEST_railway_006_check = yes
	WA_TEST_railway_007_check = yes
	WA_TEST_railway_008_check = yes
}

############################################################################################################
#	TEST 001: Land War Strategy
#	When at war, railway projects should appear in queue targeting Asian mainland states
#	Fail codes: 1=not at war, 2=no railways in queue, 3=no railways target Asia (continent=4)
############################################################################################################

WA_TEST_railway_001_launch = {
	set_temp_variable = { _wt_test_id = 1 }

	if = { limit = { check_variable = { WA_TEST_state^1 = @WA_TEST_PASSED } }
		log = "[GetYear] [GetMonth] | TEST | [This.GetName] | TEST 001: already PASSED, skipping re-launch"
	}
	else_if = { limit = { check_variable = { WA_TEST_state^1 = @WA_TEST_FAILED } }
		# Already resolved
	}
	else_if = { limit = { check_variable = { WA_TEST_state^1 = @WA_TEST_ONGOING } }
		# Already running
	}
	else_if = {
		limit = { has_war = yes }
		set_variable = { WA_TEST_state^1 = @WA_TEST_ONGOING }
		set_variable = { WA_TEST_launch_day^1 = global.num_days }
		log = "[GetYear] [GetMonth] | TEST | [This.GetName] | TEST 001 (Land War): LAUNCHED (war started)"
	}
	else = {
		# Not at war yet - stay NOT_LAUNCHED, will be re-attempted by checker
	}
}

WA_TEST_railway_001_check = {
	if = {
		limit = { check_variable = { WA_TEST_state^1 = @WA_TEST_ONGOING } }

		set_temp_variable = { _wt_test_id = 1 }
		set_temp_variable = { _wt_railway_count = 0 }
		set_temp_variable = { _wt_asia_railway_count = 0 }

		for_each_loop = { array = WA_AI_PC_queue value = _wt_proj
			if = {
				limit = { check_variable = { WA_AI_PC_building_type^_wt_proj = 13 } }
				add_to_temp_variable = { _wt_railway_count = 1 }

				# Check if target state is on Asia continent (continent_id=4)
				set_temp_variable = { _wt_proj_state = WA_AI_PC_target_state^_wt_proj }
				if = {
					limit = { check_variable = { _wt_proj_state > 0 } }
					var:_wt_proj_state = {
						WA_AI_PC_railway_get_continent = yes
					}
					if = {
						limit = { check_variable = { continent_id_ = 4 } }
						add_to_temp_variable = { _wt_asia_railway_count = 1 }
					}
				}
			}
		}

		log = "[GetYear] [GetMonth] | TEST | [This.GetName] | TEST 001 CHECK: railway_count=[?_wt_railway_count] asia_railway_count=[?_wt_asia_railway_count]"

		if = {
			limit = { check_variable = { _wt_railway_count = 0 } }
			# No railways yet - remain ONGOING (system might not have run yet)
		}
		else_if = {
			limit = { check_variable = { _wt_asia_railway_count > 0 } }
			WA_TEST_mark_passed = yes
		}
		else = {
			# Railways exist but none target Asia
			set_temp_variable = { _wt_fail_code = 3 }
			WA_TEST_mark_failed = yes
		}
	}
}

############################################################################################################
#	TEST 002: Overseas Strategy
#	When at war with overseas enemies, port upgrade projects (type 14) should appear
#	Fail codes: 1=not at war, 2=no overseas enemy, 3=no port upgrades queued
############################################################################################################

WA_TEST_railway_002_launch = {
	set_temp_variable = { _wt_test_id = 2 }

	if = { limit = { check_variable = { WA_TEST_state^2 = @WA_TEST_PASSED } }
		log = "[GetYear] [GetMonth] | TEST | [This.GetName] | TEST 002: already PASSED, skipping re-launch"
	}
	else_if = { limit = { check_variable = { WA_TEST_state^2 = @WA_TEST_FAILED } }
		# Already resolved
	}
	else_if = { limit = { check_variable = { WA_TEST_state^2 = @WA_TEST_ONGOING } }
		# Already running
	}
	else_if = {
		limit = { has_war = yes }
		set_variable = { WA_TEST_state^2 = @WA_TEST_ONGOING }
		set_variable = { WA_TEST_launch_day^2 = global.num_days }
		log = "[GetYear] [GetMonth] | TEST | [This.GetName] | TEST 002 (Overseas Strategy): LAUNCHED (war started)"
	}
	else = {
		# Not at war yet - stay NOT_LAUNCHED, will be re-attempted by checker
	}
}

WA_TEST_railway_002_check = {
	if = {
		limit = { check_variable = { WA_TEST_state^2 = @WA_TEST_ONGOING } }

		set_temp_variable = { _wt_test_id = 2 }
		set_temp_variable = { _wt_port_project_count = 0 }
		set_temp_variable = { _wt_any_project_count = 0 }

		for_each_loop = { array = WA_AI_PC_queue value = _wt_proj
			if = { limit = { check_variable = { WA_AI_PC_building_type^_wt_proj = 14 } }
				add_to_temp_variable = { _wt_port_project_count = 1 }
			}
			if = { limit = { check_variable = { WA_AI_PC_building_type^_wt_proj = 13 } }
				add_to_temp_variable = { _wt_any_project_count = 1 }
			}
		}

		log = "[GetYear] [GetMonth] | TEST | [This.GetName] | TEST 002 CHECK: port_projects=[?_wt_port_project_count] railway_projects=[?_wt_any_project_count]"

		if = {
			limit = {
				check_variable = { _wt_port_project_count = 0 }
				check_variable = { _wt_any_project_count = 0 }
			}
			# No projects yet - stay ONGOING
		}
		else_if = {
			limit = { check_variable = { _wt_port_project_count > 0 } }
			# PASS: Port upgrade projects exist (overseas strategy fired)
			WA_TEST_mark_passed = yes
		}
		else = {
			# Railways exist but no port upgrades - check if any overseas enemy exists
			set_temp_variable = { _wt_has_overseas = 0 }
			every_enemy_country = {
				set_temp_variable = { _check_enemy_tag = THIS }
				ROOT = { WA_AI_PC_has_land_border_with_enemy = yes }
				if = {
					limit = { check_variable = { has_land_border_with_enemy_ = 0 } }
					ROOT = { set_temp_variable = { _wt_has_overseas = 1 } }
				}
			}

			if = {
				limit = { check_variable = { _wt_has_overseas = 0 } }
				# No overseas enemy exists - test not applicable
				set_temp_variable = { _wt_fail_code = 2 }
				WA_TEST_mark_failed = yes
			}
			# else: overseas enemy exists but no port projects yet - stay ONGOING
		}
	}
}

############################################################################################################
#	TEST 003: Ryukyu Islands Filter (State 1053)
#	State 1053 (small_island, naval bases only, no supply_node) must be detected as single-node
#	No railway project should ever target state 1053
#	Fail codes: 1=single_node detection failed, 2=railway project targets 1053
############################################################################################################

WA_TEST_railway_003_launch = {
	set_temp_variable = { _wt_test_id = 3 }

	if = { limit = { check_variable = { WA_TEST_state^3 = @WA_TEST_PASSED } }
		log = "[GetYear] [GetMonth] | TEST | [This.GetName] | TEST 003: already PASSED, skipping re-launch"
	}
	else_if = { limit = { NOT = { 1053 = { is_controlled_by = PREV } } }
		WA_TEST_mark_skipped = yes
	}
	else = {
		set_variable = { WA_TEST_state^3 = @WA_TEST_ONGOING }
		set_variable = { WA_TEST_launch_day^3 = global.num_days }
		log = "[GetYear] [GetMonth] | TEST | [This.GetName] | TEST 003 (Ryukyu Filter): LAUNCHED"
	}
}

WA_TEST_railway_003_check = {
	if = {
		limit = { check_variable = { WA_TEST_state^3 = @WA_TEST_ONGOING } }

		set_temp_variable = { _wt_test_id = 3 }

		# Assertion 1: Call single_node detection on state 1053
		1053 = { WA_AI_PC_coastal_state_is_single_node = yes }

		if = {
			limit = { check_variable = { is_single_node_ = 0 } }
			set_temp_variable = { _wt_fail_code = 1 }
			WA_TEST_mark_failed = yes
			log = "[GetYear] [GetMonth] | TEST | [This.GetName] | TEST 003: ASSERTION FAIL - state 1053 is_single_node_=[?is_single_node_] (expected 1)"
		}
		else = {
			# Assertion 2: No railway project targets state 1053
			set_temp_variable = { _wt_found_1053 = 0 }
			for_each_loop = { array = WA_AI_PC_queue value = _wt_proj
				if = {
					limit = {
						check_variable = { WA_AI_PC_building_type^_wt_proj = 13 }
						check_variable = { WA_AI_PC_target_state^_wt_proj = 1053 }
					}
					set_temp_variable = { _wt_found_1053 = 1 }
				}
			}

			if = {
				limit = { check_variable = { _wt_found_1053 = 1 } }
				set_temp_variable = { _wt_fail_code = 2 }
				WA_TEST_mark_failed = yes
				log = "[GetYear] [GetMonth] | TEST | [This.GetName] | TEST 003: ASSERTION FAIL - found railway project targeting state 1053"
			}
			else = {
				WA_TEST_mark_passed = yes
			}
		}
	}
}

############################################################################################################
#	TEST 004: Pre-War Target Detection
#	Before war, railway projects with priority=5000 (prewar) should appear for wargoals/claims
#	Fail codes: 1=already at war, 2=no railways, 3=no prewar-priority railways
############################################################################################################

WA_TEST_railway_004_launch = {
	set_temp_variable = { _wt_test_id = 4 }

	if = { limit = { check_variable = { WA_TEST_state^4 = @WA_TEST_PASSED } }
		log = "[GetYear] [GetMonth] | TEST | [This.GetName] | TEST 004: already PASSED, skipping re-launch"
	}
	else_if = { limit = { check_variable = { WA_TEST_state^4 = @WA_TEST_FAILED } }
		# Already resolved (timeout or skip)
	}
	else_if = { limit = { check_variable = { WA_TEST_state^4 = @WA_TEST_ONGOING } }
		# Already running
	}
	else_if = { limit = { has_war = yes }
		WA_TEST_mark_skipped = yes
		log = "[GetYear] [GetMonth] | TEST | [This.GetName] | TEST 004: SKIPPED (already at war)"
	}
	else_if = {
		limit = {
			# Railway system requires 75+ civs during peace (on_actions gate)
			num_of_civilian_factories > 75
			# Target country exists with a VIABLE land border:
			# target owns a state neighboring a ROOT-controlled state with a supply hub and no level 3 railway
			# This mirrors the pre-war strategy's land path filter
			any_country = {
				exists = yes
				NOT = { tag = ROOT }
				NOT = { is_in_faction_with = ROOT }
				NOT = { is_subject_of = ROOT }
				OR = {
					ROOT = { is_justifying_wargoal_against = PREV }
					ROOT = { has_wargoal_against = PREV }
				}
				any_owned_state = {
					any_neighbor_state = {
						is_controlled_by = ROOT
						WA_AI_PC_state_has_supply_hub = yes
						NOT = { WA_AI_PC_state_has_railway_at_level_3 = yes }
					}
				}
			}
		}
		set_variable = { WA_TEST_state^4 = @WA_TEST_ONGOING }
		set_variable = { WA_TEST_launch_day^4 = global.num_days }
		log = "[GetYear] [GetMonth] | TEST | [This.GetName] | TEST 004 (Pre-War Targets): LAUNCHED (viable targets found)"
	}
	else = {
		# Preconditions not met yet - stay NOT_LAUNCHED, will be re-attempted by checker
	}
}

WA_TEST_railway_004_check = {
	if = {
		limit = { check_variable = { WA_TEST_state^4 = @WA_TEST_ONGOING } }

		set_temp_variable = { _wt_test_id = 4 }
		set_temp_variable = { _wt_railway_count = 0 }
		set_temp_variable = { _wt_prewar_count = 0 }

		for_each_loop = { array = WA_AI_PC_queue value = _wt_proj
			if = {
				limit = { check_variable = { WA_AI_PC_building_type^_wt_proj = 13 } }
				add_to_temp_variable = { _wt_railway_count = 1 }

				# Check priority = 5000 (prewar)
				if = {
					limit = { check_variable = { WA_AI_PC_priority^_wt_proj = 5000 } }
					add_to_temp_variable = { _wt_prewar_count = 1 }
				}
			}
		}

		log = "[GetYear] [GetMonth] | TEST | [This.GetName] | TEST 004 CHECK: railway_count=[?_wt_railway_count] prewar_priority_count=[?_wt_prewar_count]"

		if = {
			limit = { check_variable = { _wt_railway_count = 0 } }
			# No railways yet - stay ONGOING
		}
		else_if = {
			limit = { check_variable = { _wt_prewar_count > 0 } }
			WA_TEST_mark_passed = yes
		}
		else = {
			set_temp_variable = { _wt_fail_code = 3 }
			WA_TEST_mark_failed = yes
		}
	}
}

############################################################################################################
#	TEST 005: Queue Data Integrity
#	Every railway project (type 13) must have valid data fields
#	Fail codes: 1=target_province 0, 2=connect_province 0, 3=target_state 0,
#	            4=project_cost<=0, 5=progress<=0, 6=priority<=0
############################################################################################################

WA_TEST_railway_005_launch = {
	set_temp_variable = { _wt_test_id = 5 }

	if = { limit = { check_variable = { WA_TEST_state^5 = @WA_TEST_PASSED } }
		log = "[GetYear] [GetMonth] | TEST | [This.GetName] | TEST 005: already PASSED, skipping re-launch"
	}
	else_if = { limit = { check_variable = { WA_TEST_state^5 = @WA_TEST_FAILED } }
		# Already resolved
	}
	else_if = { limit = { check_variable = { WA_TEST_state^5 = @WA_TEST_ONGOING } }
		# Already running
	}
	else_if = {
		limit = {
			OR = {
				has_war = yes
				AND = {
					# Railway system requires 75+ civs during peace (on_actions gate)
					num_of_civilian_factories > 75
					# Target country exists with a VIABLE land border:
					# target owns a state neighboring a ROOT-controlled state with a supply hub and no level 3 railway
					# This mirrors the pre-war strategy's land path filter
					any_country = {
						exists = yes
						NOT = { tag = ROOT }
						NOT = { is_in_faction_with = ROOT }
						NOT = { is_subject_of = ROOT }
						OR = {
							ROOT = { is_justifying_wargoal_against = PREV }
							ROOT = { has_wargoal_against = PREV }
						}
						any_owned_state = {
							any_neighbor_state = {
								is_controlled_by = ROOT
								WA_AI_PC_state_has_supply_hub = yes
								NOT = { WA_AI_PC_state_has_railway_at_level_3 = yes }
							}
						}
					}
				}
			}
		}
		set_variable = { WA_TEST_state^5 = @WA_TEST_ONGOING }
		set_variable = { WA_TEST_launch_day^5 = global.num_days }
		log = "[GetYear] [GetMonth] | TEST | [This.GetName] | TEST 005 (Queue Data Integrity): LAUNCHED (railway conditions active)"
	}
	else = {
		# No railway triggers active yet - stay NOT_LAUNCHED, will be re-attempted by checker
	}
}

WA_TEST_railway_005_check = {
	if = {
		limit = { check_variable = { WA_TEST_state^5 = @WA_TEST_ONGOING } }

		set_temp_variable = { _wt_test_id = 5 }
		set_temp_variable = { _wt_railway_count = 0 }
		set_temp_variable = { _wt_invalid_found = 0 }
		set_temp_variable = { _wt_invalid_code = 0 }

		for_each_loop = { array = WA_AI_PC_queue value = _wt_proj
			if = {
				limit = {
					check_variable = { WA_AI_PC_building_type^_wt_proj = 13 }
					check_variable = { _wt_invalid_found = 0 }
				}
				add_to_temp_variable = { _wt_railway_count = 1 }

				# Validate target_province
				if = {
					limit = { NOT = { check_variable = { WA_AI_PC_target_province^_wt_proj > 0 } } }
					set_temp_variable = { _wt_invalid_found = 1 }
					set_temp_variable = { _wt_invalid_code = 1 }
					log = "[GetYear] [GetMonth] | TEST | [This.GetName] | TEST 005: INVALID proj=[?_wt_proj] target_province=[?WA_AI_PC_target_province^_wt_proj]"
				}
				# Validate connect_province
				if = {
					limit = {
						check_variable = { _wt_invalid_found = 0 }
						NOT = { check_variable = { WA_AI_PC_connect_province^_wt_proj > 0 } }
					}
					set_temp_variable = { _wt_invalid_found = 1 }
					set_temp_variable = { _wt_invalid_code = 2 }
					log = "[GetYear] [GetMonth] | TEST | [This.GetName] | TEST 005: INVALID proj=[?_wt_proj] connect_province=[?WA_AI_PC_connect_province^_wt_proj]"
				}
				# Validate target_state
				if = {
					limit = {
						check_variable = { _wt_invalid_found = 0 }
						NOT = { check_variable = { WA_AI_PC_target_state^_wt_proj > 0 } }
					}
					set_temp_variable = { _wt_invalid_found = 1 }
					set_temp_variable = { _wt_invalid_code = 3 }
					log = "[GetYear] [GetMonth] | TEST | [This.GetName] | TEST 005: INVALID proj=[?_wt_proj] target_state=[?WA_AI_PC_target_state^_wt_proj]"
				}
				# Validate project_cost
				if = {
					limit = {
						check_variable = { _wt_invalid_found = 0 }
						NOT = { check_variable = { WA_AI_PC_project_cost^_wt_proj > 0 } }
					}
					set_temp_variable = { _wt_invalid_found = 1 }
					set_temp_variable = { _wt_invalid_code = 4 }
					log = "[GetYear] [GetMonth] | TEST | [This.GetName] | TEST 005: INVALID proj=[?_wt_proj] project_cost=[?WA_AI_PC_project_cost^_wt_proj]"
				}
				# Validate progress
				if = {
					limit = {
						check_variable = { _wt_invalid_found = 0 }
						NOT = { check_variable = { WA_AI_PC_progress^_wt_proj > 0 } }
					}
					set_temp_variable = { _wt_invalid_found = 1 }
					set_temp_variable = { _wt_invalid_code = 5 }
					log = "[GetYear] [GetMonth] | TEST | [This.GetName] | TEST 005: INVALID proj=[?_wt_proj] progress=[?WA_AI_PC_progress^_wt_proj]"
				}
				# Validate priority
				if = {
					limit = {
						check_variable = { _wt_invalid_found = 0 }
						NOT = { check_variable = { WA_AI_PC_priority^_wt_proj > 0 } }
					}
					set_temp_variable = { _wt_invalid_found = 1 }
					set_temp_variable = { _wt_invalid_code = 6 }
					log = "[GetYear] [GetMonth] | TEST | [This.GetName] | TEST 005: INVALID proj=[?_wt_proj] priority=[?WA_AI_PC_priority^_wt_proj]"
				}
			}
		}

		if = {
			limit = { check_variable = { _wt_railway_count = 0 } }
			# No railways to check yet - remain ONGOING
		}
		else_if = {
			limit = { check_variable = { _wt_invalid_found = 1 } }
			set_temp_variable = { _wt_fail_code = _wt_invalid_code }
			WA_TEST_mark_failed = yes
		}
		else = {
			log = "[GetYear] [GetMonth] | TEST | [This.GetName] | TEST 005: Validated [?_wt_railway_count] railway projects - all fields valid"
			WA_TEST_mark_passed = yes
		}
	}
}

############################################################################################################
#	TEST 006: Home Port Selection
#	Port upgrades should target a Japanese home island state (282, 528-536)
#	Fail codes: 1=no port projects, 2=port targets non-home-island state
############################################################################################################

WA_TEST_railway_006_launch = {
	set_temp_variable = { _wt_test_id = 6 }

	if = { limit = { check_variable = { WA_TEST_state^6 = @WA_TEST_PASSED } }
		log = "[GetYear] [GetMonth] | TEST | [This.GetName] | TEST 006: already PASSED, skipping re-launch"
	}
	else_if = { limit = { check_variable = { WA_TEST_state^6 = @WA_TEST_FAILED } }
		# Already resolved
	}
	else_if = { limit = { check_variable = { WA_TEST_state^6 = @WA_TEST_ONGOING } }
		# Already running
	}
	else_if = {
		limit = { has_war = yes }
		set_variable = { WA_TEST_state^6 = @WA_TEST_ONGOING }
		set_variable = { WA_TEST_launch_day^6 = global.num_days }
		log = "[GetYear] [GetMonth] | TEST | [This.GetName] | TEST 006 (Home Port Selection): LAUNCHED (war started)"
	}
	else = {
		# Not at war yet - stay NOT_LAUNCHED, will be re-attempted by checker
	}
}

WA_TEST_railway_006_check = {
	if = {
		limit = { check_variable = { WA_TEST_state^6 = @WA_TEST_ONGOING } }

		set_temp_variable = { _wt_test_id = 6 }
		set_temp_variable = { _wt_port_count = 0 }
		set_temp_variable = { _wt_home_island_port = 0 }
		set_temp_variable = { _wt_non_home_port = 0 }

		for_each_loop = { array = WA_AI_PC_queue value = _wt_proj
			if = {
				limit = { check_variable = { WA_AI_PC_building_type^_wt_proj = 14 } }
				add_to_temp_variable = { _wt_port_count = 1 }

				set_temp_variable = { _wt_pstate = WA_AI_PC_target_state^_wt_proj }
				# Check if target state is a Japanese home island
				if = {
					limit = {
						OR = {
							check_variable = { _wt_pstate = 282 }
							check_variable = { _wt_pstate = 528 }
							check_variable = { _wt_pstate = 529 }
							check_variable = { _wt_pstate = 530 }
							check_variable = { _wt_pstate = 531 }
							check_variable = { _wt_pstate = 532 }
							check_variable = { _wt_pstate = 533 }
							check_variable = { _wt_pstate = 534 }
							check_variable = { _wt_pstate = 535 }
							check_variable = { _wt_pstate = 536 }
						}
					}
					set_temp_variable = { _wt_home_island_port = 1 }
				}
				else = {
					set_temp_variable = { _wt_non_home_port = 1 }
				}
			}
		}

		log = "[GetYear] [GetMonth] | TEST | [This.GetName] | TEST 006 CHECK: port_count=[?_wt_port_count] home_island=[?_wt_home_island_port] non_home=[?_wt_non_home_port]"

		if = {
			limit = { check_variable = { _wt_port_count = 0 } }
			# No port projects yet - stay ONGOING
		}
		else_if = {
			limit = { check_variable = { _wt_home_island_port = 1 } }
			WA_TEST_mark_passed = yes
		}
		else = {
			set_temp_variable = { _wt_fail_code = 2 }
			WA_TEST_mark_failed = yes
		}
	}
}

############################################################################################################
#	TEST 007: Supply Chain Analysis for Overseas Territory
#	Directly call WA_AI_PC_analyze_overseas_supply_chain and validate output
#	Fail codes: 1=route_start=0, 2=max_level=0, 3=max_level>5, 4=receiving_port_state=0,
#	            5=landmass data invalid
############################################################################################################

WA_TEST_railway_007_launch = {
	set_temp_variable = { _wt_test_id = 7 }

	if = { limit = { check_variable = { WA_TEST_state^7 = @WA_TEST_PASSED } }
		log = "[GetYear] [GetMonth] | TEST | [This.GetName] | TEST 007: already PASSED, skipping re-launch"
	}
	else = {
		set_variable = { WA_TEST_state^7 = @WA_TEST_ONGOING }
		set_variable = { WA_TEST_launch_day^7 = global.num_days }
		log = "[GetYear] [GetMonth] | TEST | [This.GetName] | TEST 007 (Supply Chain Analysis): LAUNCHED"
	}
}

WA_TEST_railway_007_check = {
	if = {
		limit = { check_variable = { WA_TEST_state^7 = @WA_TEST_ONGOING } }

		set_temp_variable = { _wt_test_id = 7 }

		# Get capital info
		WA_AI_MAP_get_capital_vp_province = yes
		set_temp_variable = { capital_province = capital_vp_province_ }
		set_temp_variable = { capital_state_id = capital_state_id_ }
		set_temp_variable = { capital_landmass = global.WA_AI_MAP_state_landmass^capital_state_id }

		# Korea (state 525) is on the Asian mainland - use its landmass as target
		set_temp_variable = { target_landmass = global.WA_AI_MAP_state_landmass^525 }

		log = "[GetYear] [GetMonth] | TEST | [This.GetName] | TEST 007: capital_landmass=[?capital_landmass] target_landmass(Korea 525)=[?target_landmass]"

		# Proceed only if both landmasses are known and different
		if = {
			limit = {
				check_variable = { capital_landmass > 0 }
				check_variable = { target_landmass > 0 }
				NOT = { check_variable = { capital_landmass = target_landmass } }
			}

			# Call the supply chain analyzer
			WA_AI_PC_analyze_overseas_supply_chain = yes

			log = "[GetYear] [GetMonth] | TEST | [This.GetName] | TEST 007: route_start=[?overseas_route_start_] max_level=[?overseas_max_railway_level_] port_state=[?overseas_receiving_port_state_]"

			# Assertion 1: route_start > 0
			if = {
				limit = { NOT = { check_variable = { overseas_route_start_ > 0 } } }
				set_temp_variable = { _wt_fail_code = 1 }
				WA_TEST_mark_failed = yes
			}
			# Assertion 2: max_railway_level > 0
			else_if = {
				limit = { NOT = { check_variable = { overseas_max_railway_level_ > 0 } } }
				set_temp_variable = { _wt_fail_code = 2 }
				WA_TEST_mark_failed = yes
			}
			# Assertion 3: max_railway_level <= 5
			else_if = {
				limit = { check_variable = { overseas_max_railway_level_ > 5 } }
				set_temp_variable = { _wt_fail_code = 3 }
				WA_TEST_mark_failed = yes
			}
			# Assertion 4: receiving_port_state > 0
			else_if = {
				limit = { NOT = { check_variable = { overseas_receiving_port_state_ > 0 } } }
				set_temp_variable = { _wt_fail_code = 4 }
				WA_TEST_mark_failed = yes
			}
			else = {
				WA_TEST_mark_passed = yes
			}
		}
		else = {
			set_temp_variable = { _wt_fail_code = 5 }
			WA_TEST_mark_failed = yes
			log = "[GetYear] [GetMonth] | TEST | [This.GetName] | TEST 007: FAIL - landmass data invalid or same"
		}
	}
}

############################################################################################################
#	TEST 008: Single-Node State Detection
#	State 1053 (Ryukyu) should be single_node=1, State 528 (Kyushu) should be single_node=0
#	Fail codes: 1=state 1053 not detected as single_node, 2=state 528 incorrectly detected
############################################################################################################

WA_TEST_railway_008_launch = {
	set_temp_variable = { _wt_test_id = 8 }

	if = { limit = { check_variable = { WA_TEST_state^8 = @WA_TEST_PASSED } }
		log = "[GetYear] [GetMonth] | TEST | [This.GetName] | TEST 008: already PASSED, skipping re-launch"
	}
	else_if = {
		limit = {
			NOT = {
				AND = {
					1053 = { is_controlled_by = PREV }
					528 = { is_controlled_by = PREV }
				}
			}
		}
		WA_TEST_mark_skipped = yes
	}
	else = {
		set_variable = { WA_TEST_state^8 = @WA_TEST_ONGOING }
		set_variable = { WA_TEST_launch_day^8 = global.num_days }
		log = "[GetYear] [GetMonth] | TEST | [This.GetName] | TEST 008 (Single-Node Detection): LAUNCHED"
	}
}

WA_TEST_railway_008_check = {
	if = {
		limit = { check_variable = { WA_TEST_state^8 = @WA_TEST_ONGOING } }

		set_temp_variable = { _wt_test_id = 8 }

		# Assertion 1: State 1053 (Ryukyu) IS a single-node state
		1053 = { WA_AI_PC_coastal_state_is_single_node = yes }
		set_temp_variable = { _wt_ryukyu_result = is_single_node_ }

		# Assertion 2: State 528 (Kyushu) is NOT a single-node state
		528 = { WA_AI_PC_coastal_state_is_single_node = yes }
		set_temp_variable = { _wt_kyushu_result = is_single_node_ }

		log = "[GetYear] [GetMonth] | TEST | [This.GetName] | TEST 008: ryukyu(1053)=[?_wt_ryukyu_result] kyushu(528)=[?_wt_kyushu_result]"

		if = {
			limit = { check_variable = { _wt_ryukyu_result = 0 } }
			set_temp_variable = { _wt_fail_code = 1 }
			WA_TEST_mark_failed = yes
		}
		else_if = {
			limit = { check_variable = { _wt_kyushu_result = 1 } }
			set_temp_variable = { _wt_fail_code = 2 }
			WA_TEST_mark_failed = yes
		}
		else = {
			WA_TEST_mark_passed = yes
		}
	}
}
