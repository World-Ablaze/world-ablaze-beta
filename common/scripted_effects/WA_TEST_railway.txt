############################################################################################################
#	World Ablaze - Railway AI Functional Test Suite (Self-Contained)
#	Test bed: Japan (JAP) - early war, island nation, multiple theatres, edge cases
#	8 tests covering land war, overseas, pre-war, queue integrity, primitives
#	Contains its own helpers (mark, init, summary, print) using WA_TEST_RW_* variable prefix
############################################################################################################

### Test State Constants
@WA_TEST_RW_NOT_LAUNCHED = 0
@WA_TEST_RW_ONGOING = 1
@WA_TEST_RW_PASSED = 2
@WA_TEST_RW_FAILED = 3
@WA_TEST_RW_TIMEOUT_DAYS = 120

############################################################################################################
#	HELPERS
############################################################################################################

WA_TEST_RW_mark_passed = {
	set_variable = { WA_TEST_RW_state^_wt_test_id = @WA_TEST_RW_PASSED }
	set_variable = { WA_TEST_RW_end_day^_wt_test_id = global.num_days }
	log = "[GetYear] [GetMonth] | TEST | [This.GetName] | RW TEST [?_wt_test_id]: PASSED"
}

WA_TEST_RW_mark_failed = {
	set_variable = { WA_TEST_RW_state^_wt_test_id = @WA_TEST_RW_FAILED }
	set_variable = { WA_TEST_RW_fail_code^_wt_test_id = _wt_fail_code }
	set_variable = { WA_TEST_RW_end_day^_wt_test_id = global.num_days }
	log = "[GetYear] [GetMonth] | TEST | [This.GetName] | RW TEST [?_wt_test_id]: FAILED (code=[?_wt_fail_code])"
}

WA_TEST_RW_mark_skipped = {
	set_variable = { WA_TEST_RW_state^_wt_test_id = @WA_TEST_RW_FAILED }
	set_variable = { WA_TEST_RW_fail_code^_wt_test_id = 99 }
	set_variable = { WA_TEST_RW_end_day^_wt_test_id = global.num_days }
	log = "[GetYear] [GetMonth] | TEST | [This.GetName] | RW TEST [?_wt_test_id]: SKIPPED (preconditions not met)"
}

WA_TEST_RW_check_timeout = {
	if = {
		limit = { check_variable = { WA_TEST_RW_state^_wt_test_id = @WA_TEST_RW_ONGOING } }

		set_temp_variable = { _wt_elapsed = global.num_days }
		subtract_from_temp_variable = { _wt_elapsed = WA_TEST_RW_launch_day^_wt_test_id }

		if = {
			limit = { check_variable = { _wt_elapsed > @WA_TEST_RW_TIMEOUT_DAYS } }
			set_temp_variable = { _wt_fail_code = 98 }
			WA_TEST_RW_mark_failed = yes
			log = "[GetYear] [GetMonth] | TEST | [This.GetName] | RW TEST [?_wt_test_id]: TIMEOUT after [?_wt_elapsed] days"
		}
	}
}

############################################################################################################
#	INIT
#	Resets test variables for tests that are NOT already PASSED
#	Preserves prior successes across re-runs
############################################################################################################

WA_TEST_RW_init = {
	log = "[GetYear] [GetMonth] | TEST | [This.GetName] | RW INIT: Resetting non-PASSED test states"

	# Test 1
	if = { limit = { check_variable = { WA_TEST_RW_state^1 = @WA_TEST_RW_PASSED } }
		log = "[GetYear] [GetMonth] | TEST | [This.GetName] | RW TEST 001: preserving previous PASS"
	}
	else = {
		set_variable = { WA_TEST_RW_state^1 = @WA_TEST_RW_NOT_LAUNCHED }
		set_variable = { WA_TEST_RW_fail_code^1 = 0 }
		set_variable = { WA_TEST_RW_launch_day^1 = 0 }
		set_variable = { WA_TEST_RW_end_day^1 = 0 }
	}

	# Test 2
	if = { limit = { check_variable = { WA_TEST_RW_state^2 = @WA_TEST_RW_PASSED } }
		log = "[GetYear] [GetMonth] | TEST | [This.GetName] | RW TEST 002: preserving previous PASS"
	}
	else = {
		set_variable = { WA_TEST_RW_state^2 = @WA_TEST_RW_NOT_LAUNCHED }
		set_variable = { WA_TEST_RW_fail_code^2 = 0 }
		set_variable = { WA_TEST_RW_launch_day^2 = 0 }
		set_variable = { WA_TEST_RW_end_day^2 = 0 }
	}

	# Test 3
	if = { limit = { check_variable = { WA_TEST_RW_state^3 = @WA_TEST_RW_PASSED } }
		log = "[GetYear] [GetMonth] | TEST | [This.GetName] | RW TEST 003: preserving previous PASS"
	}
	else = {
		set_variable = { WA_TEST_RW_state^3 = @WA_TEST_RW_NOT_LAUNCHED }
		set_variable = { WA_TEST_RW_fail_code^3 = 0 }
		set_variable = { WA_TEST_RW_launch_day^3 = 0 }
		set_variable = { WA_TEST_RW_end_day^3 = 0 }
	}

	# Test 4
	if = { limit = { check_variable = { WA_TEST_RW_state^4 = @WA_TEST_RW_PASSED } }
		log = "[GetYear] [GetMonth] | TEST | [This.GetName] | RW TEST 004: preserving previous PASS"
	}
	else = {
		set_variable = { WA_TEST_RW_state^4 = @WA_TEST_RW_NOT_LAUNCHED }
		set_variable = { WA_TEST_RW_fail_code^4 = 0 }
		set_variable = { WA_TEST_RW_launch_day^4 = 0 }
		set_variable = { WA_TEST_RW_end_day^4 = 0 }
	}

	# Test 5
	if = { limit = { check_variable = { WA_TEST_RW_state^5 = @WA_TEST_RW_PASSED } }
		log = "[GetYear] [GetMonth] | TEST | [This.GetName] | RW TEST 005: preserving previous PASS"
	}
	else = {
		set_variable = { WA_TEST_RW_state^5 = @WA_TEST_RW_NOT_LAUNCHED }
		set_variable = { WA_TEST_RW_fail_code^5 = 0 }
		set_variable = { WA_TEST_RW_launch_day^5 = 0 }
		set_variable = { WA_TEST_RW_end_day^5 = 0 }
	}

	# Test 6
	if = { limit = { check_variable = { WA_TEST_RW_state^6 = @WA_TEST_RW_PASSED } }
		log = "[GetYear] [GetMonth] | TEST | [This.GetName] | RW TEST 006: preserving previous PASS"
	}
	else = {
		set_variable = { WA_TEST_RW_state^6 = @WA_TEST_RW_NOT_LAUNCHED }
		set_variable = { WA_TEST_RW_fail_code^6 = 0 }
		set_variable = { WA_TEST_RW_launch_day^6 = 0 }
		set_variable = { WA_TEST_RW_end_day^6 = 0 }
	}

	# Test 7
	if = { limit = { check_variable = { WA_TEST_RW_state^7 = @WA_TEST_RW_PASSED } }
		log = "[GetYear] [GetMonth] | TEST | [This.GetName] | RW TEST 007: preserving previous PASS"
	}
	else = {
		set_variable = { WA_TEST_RW_state^7 = @WA_TEST_RW_NOT_LAUNCHED }
		set_variable = { WA_TEST_RW_fail_code^7 = 0 }
		set_variable = { WA_TEST_RW_launch_day^7 = 0 }
		set_variable = { WA_TEST_RW_end_day^7 = 0 }
	}

	# Test 8
	if = { limit = { check_variable = { WA_TEST_RW_state^8 = @WA_TEST_RW_PASSED } }
		log = "[GetYear] [GetMonth] | TEST | [This.GetName] | RW TEST 008: preserving previous PASS"
	}
	else = {
		set_variable = { WA_TEST_RW_state^8 = @WA_TEST_RW_NOT_LAUNCHED }
		set_variable = { WA_TEST_RW_fail_code^8 = 0 }
		set_variable = { WA_TEST_RW_launch_day^8 = 0 }
		set_variable = { WA_TEST_RW_end_day^8 = 0 }
	}

	# Test 9
	if = { limit = { check_variable = { WA_TEST_RW_state^9 = @WA_TEST_RW_PASSED } }
		log = "[GetYear] [GetMonth] | TEST | [This.GetName] | RW TEST 009: preserving previous PASS"
	}
	else = {
		set_variable = { WA_TEST_RW_state^9 = @WA_TEST_RW_NOT_LAUNCHED }
		set_variable = { WA_TEST_RW_fail_code^9 = 0 }
		set_variable = { WA_TEST_RW_launch_day^9 = 0 }
		set_variable = { WA_TEST_RW_end_day^9 = 0 }
	}

	# Test 10
	if = { limit = { check_variable = { WA_TEST_RW_state^10 = @WA_TEST_RW_PASSED } }
		log = "[GetYear] [GetMonth] | TEST | [This.GetName] | RW TEST 010: preserving previous PASS"
	}
	else = {
		set_variable = { WA_TEST_RW_state^10 = @WA_TEST_RW_NOT_LAUNCHED }
		set_variable = { WA_TEST_RW_fail_code^10 = 0 }
		set_variable = { WA_TEST_RW_launch_day^10 = 0 }
		set_variable = { WA_TEST_RW_end_day^10 = 0 }
	}

	# Test 11
	if = { limit = { check_variable = { WA_TEST_RW_state^11 = @WA_TEST_RW_PASSED } }
		log = "[GetYear] [GetMonth] | TEST | [This.GetName] | RW TEST 011: preserving previous PASS"
	}
	else = {
		set_variable = { WA_TEST_RW_state^11 = @WA_TEST_RW_NOT_LAUNCHED }
		set_variable = { WA_TEST_RW_fail_code^11 = 0 }
		set_variable = { WA_TEST_RW_launch_day^11 = 0 }
		set_variable = { WA_TEST_RW_end_day^11 = 0 }
	}

	set_variable = { WA_TEST_RW_suite_start_day = global.num_days }
	add_to_variable = { WA_TEST_RW_suite_run_count = 1 }
}

############################################################################################################
#	LOG SUMMARY
############################################################################################################

WA_TEST_RW_log_summary = {
	set_temp_variable = { _wt_count_passed = 0 }
	set_temp_variable = { _wt_count_failed = 0 }
	set_temp_variable = { _wt_count_skipped = 0 }
	set_temp_variable = { _wt_count_ongoing = 0 }
	set_temp_variable = { _wt_count_not_launched = 0 }

	# Test 1
	if = { limit = { check_variable = { WA_TEST_RW_state^1 = @WA_TEST_RW_PASSED } } add_to_temp_variable = { _wt_count_passed = 1 } }
	else_if = { limit = { check_variable = { WA_TEST_RW_state^1 = @WA_TEST_RW_FAILED } check_variable = { WA_TEST_RW_fail_code^1 = 99 } } add_to_temp_variable = { _wt_count_skipped = 1 } }
	else_if = { limit = { check_variable = { WA_TEST_RW_state^1 = @WA_TEST_RW_FAILED } } add_to_temp_variable = { _wt_count_failed = 1 } }
	else_if = { limit = { check_variable = { WA_TEST_RW_state^1 = @WA_TEST_RW_ONGOING } } add_to_temp_variable = { _wt_count_ongoing = 1 } }
	else = { add_to_temp_variable = { _wt_count_not_launched = 1 } }

	# Test 2
	if = { limit = { check_variable = { WA_TEST_RW_state^2 = @WA_TEST_RW_PASSED } } add_to_temp_variable = { _wt_count_passed = 1 } }
	else_if = { limit = { check_variable = { WA_TEST_RW_state^2 = @WA_TEST_RW_FAILED } check_variable = { WA_TEST_RW_fail_code^2 = 99 } } add_to_temp_variable = { _wt_count_skipped = 1 } }
	else_if = { limit = { check_variable = { WA_TEST_RW_state^2 = @WA_TEST_RW_FAILED } } add_to_temp_variable = { _wt_count_failed = 1 } }
	else_if = { limit = { check_variable = { WA_TEST_RW_state^2 = @WA_TEST_RW_ONGOING } } add_to_temp_variable = { _wt_count_ongoing = 1 } }
	else = { add_to_temp_variable = { _wt_count_not_launched = 1 } }

	# Test 3
	if = { limit = { check_variable = { WA_TEST_RW_state^3 = @WA_TEST_RW_PASSED } } add_to_temp_variable = { _wt_count_passed = 1 } }
	else_if = { limit = { check_variable = { WA_TEST_RW_state^3 = @WA_TEST_RW_FAILED } check_variable = { WA_TEST_RW_fail_code^3 = 99 } } add_to_temp_variable = { _wt_count_skipped = 1 } }
	else_if = { limit = { check_variable = { WA_TEST_RW_state^3 = @WA_TEST_RW_FAILED } } add_to_temp_variable = { _wt_count_failed = 1 } }
	else_if = { limit = { check_variable = { WA_TEST_RW_state^3 = @WA_TEST_RW_ONGOING } } add_to_temp_variable = { _wt_count_ongoing = 1 } }
	else = { add_to_temp_variable = { _wt_count_not_launched = 1 } }

	# Test 4
	if = { limit = { check_variable = { WA_TEST_RW_state^4 = @WA_TEST_RW_PASSED } } add_to_temp_variable = { _wt_count_passed = 1 } }
	else_if = { limit = { check_variable = { WA_TEST_RW_state^4 = @WA_TEST_RW_FAILED } check_variable = { WA_TEST_RW_fail_code^4 = 99 } } add_to_temp_variable = { _wt_count_skipped = 1 } }
	else_if = { limit = { check_variable = { WA_TEST_RW_state^4 = @WA_TEST_RW_FAILED } } add_to_temp_variable = { _wt_count_failed = 1 } }
	else_if = { limit = { check_variable = { WA_TEST_RW_state^4 = @WA_TEST_RW_ONGOING } } add_to_temp_variable = { _wt_count_ongoing = 1 } }
	else = { add_to_temp_variable = { _wt_count_not_launched = 1 } }

	# Test 5
	if = { limit = { check_variable = { WA_TEST_RW_state^5 = @WA_TEST_RW_PASSED } } add_to_temp_variable = { _wt_count_passed = 1 } }
	else_if = { limit = { check_variable = { WA_TEST_RW_state^5 = @WA_TEST_RW_FAILED } check_variable = { WA_TEST_RW_fail_code^5 = 99 } } add_to_temp_variable = { _wt_count_skipped = 1 } }
	else_if = { limit = { check_variable = { WA_TEST_RW_state^5 = @WA_TEST_RW_FAILED } } add_to_temp_variable = { _wt_count_failed = 1 } }
	else_if = { limit = { check_variable = { WA_TEST_RW_state^5 = @WA_TEST_RW_ONGOING } } add_to_temp_variable = { _wt_count_ongoing = 1 } }
	else = { add_to_temp_variable = { _wt_count_not_launched = 1 } }

	# Test 6
	if = { limit = { check_variable = { WA_TEST_RW_state^6 = @WA_TEST_RW_PASSED } } add_to_temp_variable = { _wt_count_passed = 1 } }
	else_if = { limit = { check_variable = { WA_TEST_RW_state^6 = @WA_TEST_RW_FAILED } check_variable = { WA_TEST_RW_fail_code^6 = 99 } } add_to_temp_variable = { _wt_count_skipped = 1 } }
	else_if = { limit = { check_variable = { WA_TEST_RW_state^6 = @WA_TEST_RW_FAILED } } add_to_temp_variable = { _wt_count_failed = 1 } }
	else_if = { limit = { check_variable = { WA_TEST_RW_state^6 = @WA_TEST_RW_ONGOING } } add_to_temp_variable = { _wt_count_ongoing = 1 } }
	else = { add_to_temp_variable = { _wt_count_not_launched = 1 } }

	# Test 7
	if = { limit = { check_variable = { WA_TEST_RW_state^7 = @WA_TEST_RW_PASSED } } add_to_temp_variable = { _wt_count_passed = 1 } }
	else_if = { limit = { check_variable = { WA_TEST_RW_state^7 = @WA_TEST_RW_FAILED } check_variable = { WA_TEST_RW_fail_code^7 = 99 } } add_to_temp_variable = { _wt_count_skipped = 1 } }
	else_if = { limit = { check_variable = { WA_TEST_RW_state^7 = @WA_TEST_RW_FAILED } } add_to_temp_variable = { _wt_count_failed = 1 } }
	else_if = { limit = { check_variable = { WA_TEST_RW_state^7 = @WA_TEST_RW_ONGOING } } add_to_temp_variable = { _wt_count_ongoing = 1 } }
	else = { add_to_temp_variable = { _wt_count_not_launched = 1 } }

	# Test 8
	if = { limit = { check_variable = { WA_TEST_RW_state^8 = @WA_TEST_RW_PASSED } } add_to_temp_variable = { _wt_count_passed = 1 } }
	else_if = { limit = { check_variable = { WA_TEST_RW_state^8 = @WA_TEST_RW_FAILED } check_variable = { WA_TEST_RW_fail_code^8 = 99 } } add_to_temp_variable = { _wt_count_skipped = 1 } }
	else_if = { limit = { check_variable = { WA_TEST_RW_state^8 = @WA_TEST_RW_FAILED } } add_to_temp_variable = { _wt_count_failed = 1 } }
	else_if = { limit = { check_variable = { WA_TEST_RW_state^8 = @WA_TEST_RW_ONGOING } } add_to_temp_variable = { _wt_count_ongoing = 1 } }
	else = { add_to_temp_variable = { _wt_count_not_launched = 1 } }

	# Test 9
	if = { limit = { check_variable = { WA_TEST_RW_state^9 = @WA_TEST_RW_PASSED } } add_to_temp_variable = { _wt_count_passed = 1 } }
	else_if = { limit = { check_variable = { WA_TEST_RW_state^9 = @WA_TEST_RW_FAILED } check_variable = { WA_TEST_RW_fail_code^9 = 99 } } add_to_temp_variable = { _wt_count_skipped = 1 } }
	else_if = { limit = { check_variable = { WA_TEST_RW_state^9 = @WA_TEST_RW_FAILED } } add_to_temp_variable = { _wt_count_failed = 1 } }
	else_if = { limit = { check_variable = { WA_TEST_RW_state^9 = @WA_TEST_RW_ONGOING } } add_to_temp_variable = { _wt_count_ongoing = 1 } }
	else = { add_to_temp_variable = { _wt_count_not_launched = 1 } }

	# Test 10
	if = { limit = { check_variable = { WA_TEST_RW_state^10 = @WA_TEST_RW_PASSED } } add_to_temp_variable = { _wt_count_passed = 1 } }
	else_if = { limit = { check_variable = { WA_TEST_RW_state^10 = @WA_TEST_RW_FAILED } check_variable = { WA_TEST_RW_fail_code^10 = 99 } } add_to_temp_variable = { _wt_count_skipped = 1 } }
	else_if = { limit = { check_variable = { WA_TEST_RW_state^10 = @WA_TEST_RW_FAILED } } add_to_temp_variable = { _wt_count_failed = 1 } }
	else_if = { limit = { check_variable = { WA_TEST_RW_state^10 = @WA_TEST_RW_ONGOING } } add_to_temp_variable = { _wt_count_ongoing = 1 } }
	else = { add_to_temp_variable = { _wt_count_not_launched = 1 } }

	# Test 11
	if = { limit = { check_variable = { WA_TEST_RW_state^11 = @WA_TEST_RW_PASSED } } add_to_temp_variable = { _wt_count_passed = 1 } }
	else_if = { limit = { check_variable = { WA_TEST_RW_state^11 = @WA_TEST_RW_FAILED } check_variable = { WA_TEST_RW_fail_code^11 = 99 } } add_to_temp_variable = { _wt_count_skipped = 1 } }
	else_if = { limit = { check_variable = { WA_TEST_RW_state^11 = @WA_TEST_RW_FAILED } } add_to_temp_variable = { _wt_count_failed = 1 } }
	else_if = { limit = { check_variable = { WA_TEST_RW_state^11 = @WA_TEST_RW_ONGOING } } add_to_temp_variable = { _wt_count_ongoing = 1 } }
	else = { add_to_temp_variable = { _wt_count_not_launched = 1 } }

	log = "[GetYear] [GetMonth] | TEST | [This.GetName] | RW SUMMARY: [?_wt_count_passed] PASSED, [?_wt_count_failed] FAILED, [?_wt_count_skipped] SKIPPED, [?_wt_count_ongoing] ONGOING, [?_wt_count_not_launched] NOT_LAUNCHED"
}

############################################################################################################
#	PRINT
############################################################################################################

WA_TEST_RW_print = {
	JAP = {
		if = {
			limit = { check_variable = { WA_TEST_RW_suite_run_count > 0 } }

			log = "---------------------------------------------------------------------"
			log = "  SUITE: RAILWAY"
			log = "  COUNTRY: [This.GetName] - Run #[?WA_TEST_RW_suite_run_count]"
			log = "  Started: day [?WA_TEST_RW_suite_start_day]"
			log = "---------------------------------------------------------------------"
			log = "  #   | Name                    | Status      | Code | +Launch  | +Resolved"

			### Test 001
			set_temp_variable = { _wt_s = WA_TEST_RW_state^1 }
			set_temp_variable = { _wt_fc = WA_TEST_RW_fail_code^1 }
			set_temp_variable = { _wt_ld = WA_TEST_RW_launch_day^1 }
			subtract_from_temp_variable = { _wt_ld = WA_TEST_RW_suite_start_day }
			set_temp_variable = { _wt_ed = WA_TEST_RW_end_day^1 }
			subtract_from_temp_variable = { _wt_ed = WA_TEST_RW_suite_start_day }
			if = { limit = { check_variable = { _wt_s = 2 } }
				log = "  001 | Land War                | PASSED      |    [?_wt_fc] | +[?_wt_ld]d    | +[?_wt_ed]d"
			}
			else_if = { limit = { check_variable = { _wt_s = 3 } check_variable = { _wt_fc = 99 } }
				log = "  001 | Land War                | SKIPPED     |   [?_wt_fc] | -        | -"
			}
			else_if = { limit = { check_variable = { _wt_s = 3 } }
				log = "  001 | Land War                | FAILED      |   [?_wt_fc] | +[?_wt_ld]d    | +[?_wt_ed]d"
			}
			else_if = { limit = { check_variable = { _wt_s = 1 } }
				log = "  001 | Land War                | ONGOING     |    [?_wt_fc] | +[?_wt_ld]d    | -"
			}
			else = {
				log = "  001 | Land War                | NOT_LAUNCHED |    [?_wt_fc] | -        | -"
			}

			### Test 002
			set_temp_variable = { _wt_s = WA_TEST_RW_state^2 }
			set_temp_variable = { _wt_fc = WA_TEST_RW_fail_code^2 }
			set_temp_variable = { _wt_ld = WA_TEST_RW_launch_day^2 }
			subtract_from_temp_variable = { _wt_ld = WA_TEST_RW_suite_start_day }
			set_temp_variable = { _wt_ed = WA_TEST_RW_end_day^2 }
			subtract_from_temp_variable = { _wt_ed = WA_TEST_RW_suite_start_day }
			if = { limit = { check_variable = { _wt_s = 2 } }
				log = "  002 | Overseas Strategy       | PASSED      |    [?_wt_fc] | +[?_wt_ld]d    | +[?_wt_ed]d"
			}
			else_if = { limit = { check_variable = { _wt_s = 3 } check_variable = { _wt_fc = 99 } }
				log = "  002 | Overseas Strategy       | SKIPPED     |   [?_wt_fc] | -        | -"
			}
			else_if = { limit = { check_variable = { _wt_s = 3 } }
				log = "  002 | Overseas Strategy       | FAILED      |   [?_wt_fc] | +[?_wt_ld]d    | +[?_wt_ed]d"
			}
			else_if = { limit = { check_variable = { _wt_s = 1 } }
				log = "  002 | Overseas Strategy       | ONGOING     |    [?_wt_fc] | +[?_wt_ld]d    | -"
			}
			else = {
				log = "  002 | Overseas Strategy       | NOT_LAUNCHED |    [?_wt_fc] | -        | -"
			}

			### Test 003
			set_temp_variable = { _wt_s = WA_TEST_RW_state^3 }
			set_temp_variable = { _wt_fc = WA_TEST_RW_fail_code^3 }
			set_temp_variable = { _wt_ld = WA_TEST_RW_launch_day^3 }
			subtract_from_temp_variable = { _wt_ld = WA_TEST_RW_suite_start_day }
			set_temp_variable = { _wt_ed = WA_TEST_RW_end_day^3 }
			subtract_from_temp_variable = { _wt_ed = WA_TEST_RW_suite_start_day }
			if = { limit = { check_variable = { _wt_s = 2 } }
				log = "  003 | Ryukyu Filter           | PASSED      |    [?_wt_fc] | +[?_wt_ld]d    | +[?_wt_ed]d"
			}
			else_if = { limit = { check_variable = { _wt_s = 3 } check_variable = { _wt_fc = 99 } }
				log = "  003 | Ryukyu Filter           | SKIPPED     |   [?_wt_fc] | -        | -"
			}
			else_if = { limit = { check_variable = { _wt_s = 3 } }
				log = "  003 | Ryukyu Filter           | FAILED      |   [?_wt_fc] | +[?_wt_ld]d    | +[?_wt_ed]d"
			}
			else_if = { limit = { check_variable = { _wt_s = 1 } }
				log = "  003 | Ryukyu Filter           | ONGOING     |    [?_wt_fc] | +[?_wt_ld]d    | -"
			}
			else = {
				log = "  003 | Ryukyu Filter           | NOT_LAUNCHED |    [?_wt_fc] | -        | -"
			}

			### Test 004
			set_temp_variable = { _wt_s = WA_TEST_RW_state^4 }
			set_temp_variable = { _wt_fc = WA_TEST_RW_fail_code^4 }
			set_temp_variable = { _wt_ld = WA_TEST_RW_launch_day^4 }
			subtract_from_temp_variable = { _wt_ld = WA_TEST_RW_suite_start_day }
			set_temp_variable = { _wt_ed = WA_TEST_RW_end_day^4 }
			subtract_from_temp_variable = { _wt_ed = WA_TEST_RW_suite_start_day }
			if = { limit = { check_variable = { _wt_s = 2 } }
				log = "  004 | Pre-War Targets         | PASSED      |    [?_wt_fc] | +[?_wt_ld]d    | +[?_wt_ed]d"
			}
			else_if = { limit = { check_variable = { _wt_s = 3 } check_variable = { _wt_fc = 99 } }
				log = "  004 | Pre-War Targets         | SKIPPED     |   [?_wt_fc] | -        | -"
			}
			else_if = { limit = { check_variable = { _wt_s = 3 } }
				log = "  004 | Pre-War Targets         | FAILED      |   [?_wt_fc] | +[?_wt_ld]d    | +[?_wt_ed]d"
			}
			else_if = { limit = { check_variable = { _wt_s = 1 } }
				log = "  004 | Pre-War Targets         | ONGOING     |    [?_wt_fc] | +[?_wt_ld]d    | -"
			}
			else = {
				log = "  004 | Pre-War Targets         | NOT_LAUNCHED |    [?_wt_fc] | -        | -"
			}

			### Test 005
			set_temp_variable = { _wt_s = WA_TEST_RW_state^5 }
			set_temp_variable = { _wt_fc = WA_TEST_RW_fail_code^5 }
			set_temp_variable = { _wt_ld = WA_TEST_RW_launch_day^5 }
			subtract_from_temp_variable = { _wt_ld = WA_TEST_RW_suite_start_day }
			set_temp_variable = { _wt_ed = WA_TEST_RW_end_day^5 }
			subtract_from_temp_variable = { _wt_ed = WA_TEST_RW_suite_start_day }
			if = { limit = { check_variable = { _wt_s = 2 } }
				log = "  005 | Queue Data Integrity    | PASSED      |    [?_wt_fc] | +[?_wt_ld]d    | +[?_wt_ed]d"
			}
			else_if = { limit = { check_variable = { _wt_s = 3 } check_variable = { _wt_fc = 99 } }
				log = "  005 | Queue Data Integrity    | SKIPPED     |   [?_wt_fc] | -        | -"
			}
			else_if = { limit = { check_variable = { _wt_s = 3 } }
				log = "  005 | Queue Data Integrity    | FAILED      |   [?_wt_fc] | +[?_wt_ld]d    | +[?_wt_ed]d"
			}
			else_if = { limit = { check_variable = { _wt_s = 1 } }
				log = "  005 | Queue Data Integrity    | ONGOING     |    [?_wt_fc] | +[?_wt_ld]d    | -"
			}
			else = {
				log = "  005 | Queue Data Integrity    | NOT_LAUNCHED |    [?_wt_fc] | -        | -"
			}

			### Test 006
			set_temp_variable = { _wt_s = WA_TEST_RW_state^6 }
			set_temp_variable = { _wt_fc = WA_TEST_RW_fail_code^6 }
			set_temp_variable = { _wt_ld = WA_TEST_RW_launch_day^6 }
			subtract_from_temp_variable = { _wt_ld = WA_TEST_RW_suite_start_day }
			set_temp_variable = { _wt_ed = WA_TEST_RW_end_day^6 }
			subtract_from_temp_variable = { _wt_ed = WA_TEST_RW_suite_start_day }
			if = { limit = { check_variable = { _wt_s = 2 } }
				log = "  006 | Home Port Selection     | PASSED      |    [?_wt_fc] | +[?_wt_ld]d    | +[?_wt_ed]d"
			}
			else_if = { limit = { check_variable = { _wt_s = 3 } check_variable = { _wt_fc = 99 } }
				log = "  006 | Home Port Selection     | SKIPPED     |   [?_wt_fc] | -        | -"
			}
			else_if = { limit = { check_variable = { _wt_s = 3 } }
				log = "  006 | Home Port Selection     | FAILED      |   [?_wt_fc] | +[?_wt_ld]d    | +[?_wt_ed]d"
			}
			else_if = { limit = { check_variable = { _wt_s = 1 } }
				log = "  006 | Home Port Selection     | ONGOING     |    [?_wt_fc] | +[?_wt_ld]d    | -"
			}
			else = {
				log = "  006 | Home Port Selection     | NOT_LAUNCHED |    [?_wt_fc] | -        | -"
			}

			### Test 007
			set_temp_variable = { _wt_s = WA_TEST_RW_state^7 }
			set_temp_variable = { _wt_fc = WA_TEST_RW_fail_code^7 }
			set_temp_variable = { _wt_ld = WA_TEST_RW_launch_day^7 }
			subtract_from_temp_variable = { _wt_ld = WA_TEST_RW_suite_start_day }
			set_temp_variable = { _wt_ed = WA_TEST_RW_end_day^7 }
			subtract_from_temp_variable = { _wt_ed = WA_TEST_RW_suite_start_day }
			if = { limit = { check_variable = { _wt_s = 2 } }
				log = "  007 | Supply Chain Analysis   | PASSED      |    [?_wt_fc] | +[?_wt_ld]d    | +[?_wt_ed]d"
			}
			else_if = { limit = { check_variable = { _wt_s = 3 } check_variable = { _wt_fc = 99 } }
				log = "  007 | Supply Chain Analysis   | SKIPPED     |   [?_wt_fc] | -        | -"
			}
			else_if = { limit = { check_variable = { _wt_s = 3 } }
				log = "  007 | Supply Chain Analysis   | FAILED      |   [?_wt_fc] | +[?_wt_ld]d    | +[?_wt_ed]d"
			}
			else_if = { limit = { check_variable = { _wt_s = 1 } }
				log = "  007 | Supply Chain Analysis   | ONGOING     |    [?_wt_fc] | +[?_wt_ld]d    | -"
			}
			else = {
				log = "  007 | Supply Chain Analysis   | NOT_LAUNCHED |    [?_wt_fc] | -        | -"
			}

			### Test 008
			set_temp_variable = { _wt_s = WA_TEST_RW_state^8 }
			set_temp_variable = { _wt_fc = WA_TEST_RW_fail_code^8 }
			set_temp_variable = { _wt_ld = WA_TEST_RW_launch_day^8 }
			subtract_from_temp_variable = { _wt_ld = WA_TEST_RW_suite_start_day }
			set_temp_variable = { _wt_ed = WA_TEST_RW_end_day^8 }
			subtract_from_temp_variable = { _wt_ed = WA_TEST_RW_suite_start_day }
			if = { limit = { check_variable = { _wt_s = 2 } }
				log = "  008 | Single-Node Detection   | PASSED      |    [?_wt_fc] | +[?_wt_ld]d    | +[?_wt_ed]d"
			}
			else_if = { limit = { check_variable = { _wt_s = 3 } check_variable = { _wt_fc = 99 } }
				log = "  008 | Single-Node Detection   | SKIPPED     |   [?_wt_fc] | -        | -"
			}
			else_if = { limit = { check_variable = { _wt_s = 3 } }
				log = "  008 | Single-Node Detection   | FAILED      |   [?_wt_fc] | +[?_wt_ld]d    | +[?_wt_ed]d"
			}
			else_if = { limit = { check_variable = { _wt_s = 1 } }
				log = "  008 | Single-Node Detection   | ONGOING     |    [?_wt_fc] | +[?_wt_ld]d    | -"
			}
			else = {
				log = "  008 | Single-Node Detection   | NOT_LAUNCHED |    [?_wt_fc] | -        | -"
			}

		### Test 009
		set_temp_variable = { _wt_s = WA_TEST_RW_state^9 }
		set_temp_variable = { _wt_fc = WA_TEST_RW_fail_code^9 }
		set_temp_variable = { _wt_ld = WA_TEST_RW_launch_day^9 }
		subtract_from_temp_variable = { _wt_ld = WA_TEST_RW_suite_start_day }
		set_temp_variable = { _wt_ed = WA_TEST_RW_end_day^9 }
		subtract_from_temp_variable = { _wt_ed = WA_TEST_RW_suite_start_day }
		if = { limit = { check_variable = { _wt_s = 2 } }
			log = "  009 | Capital Home Port (War)  | PASSED      |    [?_wt_fc] | +[?_wt_ld]d    | +[?_wt_ed]d"
		}
		else_if = { limit = { check_variable = { _wt_s = 3 } check_variable = { _wt_fc = 99 } }
			log = "  009 | Capital Home Port (War)  | SKIPPED     |   [?_wt_fc] | -        | -"
		}
		else_if = { limit = { check_variable = { _wt_s = 3 } }
			log = "  009 | Capital Home Port (War)  | FAILED      |   [?_wt_fc] | +[?_wt_ld]d    | +[?_wt_ed]d"
		}
		else_if = { limit = { check_variable = { _wt_s = 1 } }
			log = "  009 | Capital Home Port (War)  | ONGOING     |    [?_wt_fc] | +[?_wt_ld]d    | -"
		}
		else = {
			log = "  009 | Capital Home Port (War)  | NOT_LAUNCHED |    [?_wt_fc] | -        | -"
		}

		### Test 010
		set_temp_variable = { _wt_s = WA_TEST_RW_state^10 }
		set_temp_variable = { _wt_fc = WA_TEST_RW_fail_code^10 }
		set_temp_variable = { _wt_ld = WA_TEST_RW_launch_day^10 }
		subtract_from_temp_variable = { _wt_ld = WA_TEST_RW_suite_start_day }
		set_temp_variable = { _wt_ed = WA_TEST_RW_end_day^10 }
		subtract_from_temp_variable = { _wt_ed = WA_TEST_RW_suite_start_day }
		if = { limit = { check_variable = { _wt_s = 2 } }
			log = "  010 | Dalian Port Level       | PASSED      |    [?_wt_fc] | +[?_wt_ld]d    | +[?_wt_ed]d"
		}
		else_if = { limit = { check_variable = { _wt_s = 3 } check_variable = { _wt_fc = 99 } }
			log = "  010 | Dalian Port Level       | SKIPPED     |   [?_wt_fc] | -        | -"
		}
		else_if = { limit = { check_variable = { _wt_s = 3 } }
			log = "  010 | Dalian Port Level       | FAILED      |   [?_wt_fc] | +[?_wt_ld]d    | +[?_wt_ed]d"
		}
		else_if = { limit = { check_variable = { _wt_s = 1 } }
			log = "  010 | Dalian Port Level       | ONGOING     |    [?_wt_fc] | +[?_wt_ld]d    | -"
		}
		else = {
			log = "  010 | Dalian Port Level       | NOT_LAUNCHED |    [?_wt_fc] | -        | -"
		}

		### Test 011
		set_temp_variable = { _wt_s = WA_TEST_RW_state^11 }
		set_temp_variable = { _wt_fc = WA_TEST_RW_fail_code^11 }
		set_temp_variable = { _wt_ld = WA_TEST_RW_launch_day^11 }
		subtract_from_temp_variable = { _wt_ld = WA_TEST_RW_suite_start_day }
		set_temp_variable = { _wt_ed = WA_TEST_RW_end_day^11 }
		subtract_from_temp_variable = { _wt_ed = WA_TEST_RW_suite_start_day }
		if = { limit = { check_variable = { _wt_s = 2 } }
			log = "  011 | Dalian-Beijing Railway  | PASSED      |    [?_wt_fc] | +[?_wt_ld]d    | +[?_wt_ed]d"
		}
		else_if = { limit = { check_variable = { _wt_s = 3 } check_variable = { _wt_fc = 99 } }
			log = "  011 | Dalian-Beijing Railway  | SKIPPED     |   [?_wt_fc] | -        | -"
		}
		else_if = { limit = { check_variable = { _wt_s = 3 } }
			log = "  011 | Dalian-Beijing Railway  | FAILED      |   [?_wt_fc] | +[?_wt_ld]d    | +[?_wt_ed]d"
		}
		else_if = { limit = { check_variable = { _wt_s = 1 } }
			log = "  011 | Dalian-Beijing Railway  | ONGOING     |    [?_wt_fc] | +[?_wt_ld]d    | -"
		}
		else = {
			log = "  011 | Dalian-Beijing Railway  | NOT_LAUNCHED |    [?_wt_fc] | -        | -"
		}

			log = "---------------------------------------------------------------------"
			WA_TEST_RW_log_summary = yes
			log = "  Fail codes: 98=TIMEOUT, 99=SKIPPED"
			log = "====================================================================="
		}
	}
}

############################################################################################################
#	SUITE RUNNER
#	Scopes to JAP, initializes, launches all tests, schedules checker
############################################################################################################

WA_TEST_RW_suite = {
	JAP = {
		log = "[GetYear] [GetMonth] | TEST | [This.GetName] | ================================================"
		log = "[GetYear] [GetMonth] | TEST | [This.GetName] | RAILWAY TEST SUITE: STARTING"
		log = "[GetYear] [GetMonth] | TEST | [This.GetName] | ================================================"

		# Initialize (preserves PASSED tests)
		WA_TEST_RW_init = yes

		# Enable debug logging so railway system produces detailed output
		set_country_flag = WA_AI_construction_logging

		# Set suite active flag
		set_country_flag = WA_TEST_RW_suite_active

		# Force railway system to run on next weekly tick
		set_variable = { WA_AI_PC_railway_INTERVAL_counter = 0 }

		# Clear existing railway projects (type 13 only) to start fresh
		# Collect IDs first, then remove (avoid modifying array during iteration)
		clear_temp_array = _wt_remove_ids
		for_each_loop = { array = WA_AI_PC_queue value = _wt_proj
			if = {
				limit = { check_variable = { WA_AI_PC_building_type^_wt_proj = 13 } }
				add_to_temp_array = { _wt_remove_ids = _wt_proj }
			}
		}
		set_temp_variable = { _wt_clear_count = _wt_remove_ids^num }
		for_each_loop = { array = _wt_remove_ids value = _project_id
			WA_AI_PC_end_project_by_id = yes
		}

		log = "[GetYear] [GetMonth] | TEST | [This.GetName] | SUITE: Cleared [?_wt_clear_count] existing railway projects"

		# Launch all tests
		WA_TEST_RW_launch_all = yes

		# Schedule the first checker event (after the weekly tick fires)
		country_event = { id = wa_test.100 days = 7 }

		log = "[GetYear] [GetMonth] | TEST | [This.GetName] | SUITE: All tests launched, checker scheduled in 7 days"
		WA_TEST_RW_log_summary = yes
	}
}

############################################################################################################
#	ORCHESTRATORS
############################################################################################################

WA_TEST_RW_launch_all = {
	WA_TEST_RW_001_launch = yes
	WA_TEST_RW_002_launch = yes
	WA_TEST_RW_003_launch = yes
	WA_TEST_RW_004_launch = yes
	WA_TEST_RW_005_launch = yes
	WA_TEST_RW_006_launch = yes
	WA_TEST_RW_007_launch = yes
	WA_TEST_RW_008_launch = yes
	WA_TEST_RW_009_launch = yes
	WA_TEST_RW_010_launch = yes
	WA_TEST_RW_011_launch = yes
}

WA_TEST_RW_check_all = {
	log = "[GetYear] [GetMonth] | TEST | [This.GetName] | RW CHECK: Evaluating all ongoing tests"

	# Timeout checks first
	set_temp_variable = { _wt_test_id = 1 }
	WA_TEST_RW_check_timeout = yes
	set_temp_variable = { _wt_test_id = 2 }
	WA_TEST_RW_check_timeout = yes
	set_temp_variable = { _wt_test_id = 3 }
	WA_TEST_RW_check_timeout = yes
	set_temp_variable = { _wt_test_id = 4 }
	WA_TEST_RW_check_timeout = yes
	set_temp_variable = { _wt_test_id = 5 }
	WA_TEST_RW_check_timeout = yes
	set_temp_variable = { _wt_test_id = 6 }
	WA_TEST_RW_check_timeout = yes
	set_temp_variable = { _wt_test_id = 7 }
	WA_TEST_RW_check_timeout = yes
	set_temp_variable = { _wt_test_id = 8 }
	WA_TEST_RW_check_timeout = yes
	set_temp_variable = { _wt_test_id = 9 }
	WA_TEST_RW_check_timeout = yes
	set_temp_variable = { _wt_test_id = 10 }
	WA_TEST_RW_check_timeout = yes
	set_temp_variable = { _wt_test_id = 11 }
	WA_TEST_RW_check_timeout = yes

	# Individual test checks (only evaluates tests still ONGOING)
	WA_TEST_RW_001_check = yes
	WA_TEST_RW_002_check = yes
	WA_TEST_RW_003_check = yes
	WA_TEST_RW_004_check = yes
	WA_TEST_RW_005_check = yes
	WA_TEST_RW_006_check = yes
	WA_TEST_RW_007_check = yes
	WA_TEST_RW_008_check = yes
	WA_TEST_RW_009_check = yes
	WA_TEST_RW_010_check = yes
	WA_TEST_RW_011_check = yes
}

############################################################################################################
#	TEST 001: Land War Strategy
#	When at war, railway projects should appear in queue targeting Asian mainland states
#	Fail codes: 1=not at war, 2=no railways in queue, 3=no railways target Asia (continent=4)
############################################################################################################

WA_TEST_RW_001_launch = {
	set_temp_variable = { _wt_test_id = 1 }

	if = { limit = { check_variable = { WA_TEST_RW_state^1 = @WA_TEST_RW_PASSED } }
		log = "[GetYear] [GetMonth] | TEST | [This.GetName] | RW TEST 001: already PASSED, skipping re-launch"
	}
	else_if = { limit = { check_variable = { WA_TEST_RW_state^1 = @WA_TEST_RW_FAILED } }
		# Already resolved
	}
	else_if = { limit = { check_variable = { WA_TEST_RW_state^1 = @WA_TEST_RW_ONGOING } }
		# Already running
	}
	else_if = {
		limit = { has_war = yes }
		set_variable = { WA_TEST_RW_state^1 = @WA_TEST_RW_ONGOING }
		set_variable = { WA_TEST_RW_launch_day^1 = global.num_days }
		log = "[GetYear] [GetMonth] | TEST | [This.GetName] | RW TEST 001 (Land War): LAUNCHED (war started)"
	}
	else = {
		# Not at war yet - stay NOT_LAUNCHED, will be re-attempted by checker
	}
}

WA_TEST_RW_001_check = {
	if = {
		limit = { check_variable = { WA_TEST_RW_state^1 = @WA_TEST_RW_ONGOING } }

		set_temp_variable = { _wt_test_id = 1 }
		set_temp_variable = { _wt_railway_count = 0 }
		set_temp_variable = { _wt_asia_railway_count = 0 }

		for_each_loop = { array = WA_AI_PC_queue value = _wt_proj
			if = {
				limit = { check_variable = { WA_AI_PC_building_type^_wt_proj = 13 } }
				add_to_temp_variable = { _wt_railway_count = 1 }

				# Check if target state is on Asia continent (continent_id=4)
				set_temp_variable = { _wt_proj_state = WA_AI_PC_target_state^_wt_proj }
				if = {
					limit = { check_variable = { _wt_proj_state > 0 } }
					var:_wt_proj_state = {
						WA_AI_PC_railway_get_continent = yes
					}
					if = {
						limit = { check_variable = { continent_id_ = 4 } }
						add_to_temp_variable = { _wt_asia_railway_count = 1 }
					}
				}
			}
		}

		log = "[GetYear] [GetMonth] | TEST | [This.GetName] | RW TEST 001 CHECK: railway_count=[?_wt_railway_count] asia_railway_count=[?_wt_asia_railway_count]"

		if = {
			limit = { check_variable = { _wt_railway_count = 0 } }
			# No railways yet - remain ONGOING (system might not have run yet)
		}
		else_if = {
			limit = { check_variable = { _wt_asia_railway_count > 0 } }
			WA_TEST_RW_mark_passed = yes
		}
		else = {
			# Railways exist but none target Asia
			set_temp_variable = { _wt_fail_code = 3 }
			WA_TEST_RW_mark_failed = yes
		}
	}
}

############################################################################################################
#	TEST 002: Overseas Strategy
#	When at war with overseas enemies, port upgrade projects (type 14) should appear
#	Fail codes: 1=not at war, 2=no overseas enemy, 3=no port upgrades queued
############################################################################################################

WA_TEST_RW_002_launch = {
	set_temp_variable = { _wt_test_id = 2 }

	if = { limit = { check_variable = { WA_TEST_RW_state^2 = @WA_TEST_RW_PASSED } }
		log = "[GetYear] [GetMonth] | TEST | [This.GetName] | RW TEST 002: already PASSED, skipping re-launch"
	}
	else_if = { limit = { check_variable = { WA_TEST_RW_state^2 = @WA_TEST_RW_FAILED } }
		# Already resolved
	}
	else_if = { limit = { check_variable = { WA_TEST_RW_state^2 = @WA_TEST_RW_ONGOING } }
		# Already running
	}
	else_if = {
		limit = { has_war = yes }
		set_variable = { WA_TEST_RW_state^2 = @WA_TEST_RW_ONGOING }
		set_variable = { WA_TEST_RW_launch_day^2 = global.num_days }
		log = "[GetYear] [GetMonth] | TEST | [This.GetName] | RW TEST 002 (Overseas Strategy): LAUNCHED (war started)"
	}
	else = {
		# Not at war yet - stay NOT_LAUNCHED, will be re-attempted by checker
	}
}

WA_TEST_RW_002_check = {
	if = {
		limit = { check_variable = { WA_TEST_RW_state^2 = @WA_TEST_RW_ONGOING } }

		set_temp_variable = { _wt_test_id = 2 }
		set_temp_variable = { _wt_port_project_count = 0 }
		set_temp_variable = { _wt_any_project_count = 0 }

		for_each_loop = { array = WA_AI_PC_queue value = _wt_proj
			if = { limit = { check_variable = { WA_AI_PC_building_type^_wt_proj = 14 } }
				add_to_temp_variable = { _wt_port_project_count = 1 }
			}
			if = { limit = { check_variable = { WA_AI_PC_building_type^_wt_proj = 13 } }
				add_to_temp_variable = { _wt_any_project_count = 1 }
			}
		}

		log = "[GetYear] [GetMonth] | TEST | [This.GetName] | RW TEST 002 CHECK: port_projects=[?_wt_port_project_count] railway_projects=[?_wt_any_project_count]"

		if = {
			limit = {
				check_variable = { _wt_port_project_count = 0 }
				check_variable = { _wt_any_project_count = 0 }
			}
			# No projects yet - stay ONGOING
		}
		else_if = {
			limit = { check_variable = { _wt_port_project_count > 0 } }
			# PASS: Port upgrade projects exist (overseas strategy fired)
			WA_TEST_RW_mark_passed = yes
		}
		else = {
			# Railways exist but no port upgrades - check if any overseas enemy exists
			set_temp_variable = { _wt_has_overseas = 0 }
			every_enemy_country = {
				set_temp_variable = { _check_enemy_tag = THIS }
				ROOT = { WA_AI_PC_has_land_border_with_enemy = yes }
				if = {
					limit = { check_variable = { has_land_border_with_enemy_ = 0 } }
					ROOT = { set_temp_variable = { _wt_has_overseas = 1 } }
				}
			}

			if = {
				limit = { check_variable = { _wt_has_overseas = 0 } }
				# No overseas enemy exists - test not applicable
				set_temp_variable = { _wt_fail_code = 2 }
				WA_TEST_RW_mark_failed = yes
			}
			# else: overseas enemy exists but no port projects yet - stay ONGOING
		}
	}
}

############################################################################################################
#	TEST 003: Ryukyu Islands Filter (State 1053)
#	State 1053 (small_island, naval bases only, no supply_node) must be detected as single-node
#	No railway project should ever target state 1053
#	Fail codes: 1=single_node detection failed, 2=railway project targets 1053
############################################################################################################

WA_TEST_RW_003_launch = {
	set_temp_variable = { _wt_test_id = 3 }

	if = { limit = { check_variable = { WA_TEST_RW_state^3 = @WA_TEST_RW_PASSED } }
		log = "[GetYear] [GetMonth] | TEST | [This.GetName] | RW TEST 003: already PASSED, skipping re-launch"
	}
	else_if = { limit = { NOT = { 1053 = { is_controlled_by = PREV } } }
		WA_TEST_RW_mark_skipped = yes
	}
	else = {
		set_variable = { WA_TEST_RW_state^3 = @WA_TEST_RW_ONGOING }
		set_variable = { WA_TEST_RW_launch_day^3 = global.num_days }
		log = "[GetYear] [GetMonth] | TEST | [This.GetName] | RW TEST 003 (Ryukyu Filter): LAUNCHED"
	}
}

WA_TEST_RW_003_check = {
	if = {
		limit = { check_variable = { WA_TEST_RW_state^3 = @WA_TEST_RW_ONGOING } }

		set_temp_variable = { _wt_test_id = 3 }

		# Assertion 1: Call single_node detection on state 1053
		1053 = { WA_AI_PC_coastal_state_is_single_node = yes }

		if = {
			limit = { check_variable = { is_single_node_ = 0 } }
			set_temp_variable = { _wt_fail_code = 1 }
			WA_TEST_RW_mark_failed = yes
			log = "[GetYear] [GetMonth] | TEST | [This.GetName] | RW TEST 003: ASSERTION FAIL - state 1053 is_single_node_=[?is_single_node_] (expected 1)"
		}
		else = {
			# Assertion 2: No railway project targets state 1053
			set_temp_variable = { _wt_found_1053 = 0 }
			for_each_loop = { array = WA_AI_PC_queue value = _wt_proj
				if = {
					limit = {
						check_variable = { WA_AI_PC_building_type^_wt_proj = 13 }
						check_variable = { WA_AI_PC_target_state^_wt_proj = 1053 }
					}
					set_temp_variable = { _wt_found_1053 = 1 }
				}
			}

			if = {
				limit = { check_variable = { _wt_found_1053 = 1 } }
				set_temp_variable = { _wt_fail_code = 2 }
				WA_TEST_RW_mark_failed = yes
				log = "[GetYear] [GetMonth] | TEST | [This.GetName] | RW TEST 003: ASSERTION FAIL - found railway project targeting state 1053"
			}
			else = {
				WA_TEST_RW_mark_passed = yes
			}
		}
	}
}

############################################################################################################
#	TEST 004: Pre-War Target Detection
#	Before war, railway projects with priority=5000 (prewar) should appear for wargoals/claims
#	Fail codes: 1=already at war, 2=no railways, 3=no prewar-priority railways
############################################################################################################

WA_TEST_RW_004_launch = {
	set_temp_variable = { _wt_test_id = 4 }

	if = { limit = { check_variable = { WA_TEST_RW_state^4 = @WA_TEST_RW_PASSED } }
		log = "[GetYear] [GetMonth] | TEST | [This.GetName] | RW TEST 004: already PASSED, skipping re-launch"
	}
	else_if = { limit = { check_variable = { WA_TEST_RW_state^4 = @WA_TEST_RW_FAILED } }
		# Already resolved (timeout or skip)
	}
	else_if = { limit = { check_variable = { WA_TEST_RW_state^4 = @WA_TEST_RW_ONGOING } }
		# Already running
	}
	else_if = { limit = { has_war = yes }
		WA_TEST_RW_mark_skipped = yes
		log = "[GetYear] [GetMonth] | TEST | [This.GetName] | RW TEST 004: SKIPPED (already at war)"
	}
	else_if = {
		limit = {
			num_of_civilian_factories > 75
			any_country = {
				exists = yes
				NOT = { tag = ROOT }
				NOT = { is_in_faction_with = ROOT }
				NOT = { is_subject_of = ROOT }
				OR = {
					ROOT = { is_justifying_wargoal_against = PREV }
					ROOT = { has_wargoal_against = PREV }
				}
				any_owned_state = {
					any_neighbor_state = {
						is_controlled_by = ROOT
						WA_AI_PC_state_has_supply_hub = yes
						NOT = { WA_AI_PC_state_has_railway_at_level_5 = yes }
					}
				}
			}
		}
		set_variable = { WA_TEST_RW_state^4 = @WA_TEST_RW_ONGOING }
		set_variable = { WA_TEST_RW_launch_day^4 = global.num_days }
		log = "[GetYear] [GetMonth] | TEST | [This.GetName] | RW TEST 004 (Pre-War Targets): LAUNCHED (viable targets found)"
	}
	else = {
		# Preconditions not met yet - stay NOT_LAUNCHED, will be re-attempted by checker
	}
}

WA_TEST_RW_004_check = {
	if = {
		limit = { check_variable = { WA_TEST_RW_state^4 = @WA_TEST_RW_ONGOING } }

		set_temp_variable = { _wt_test_id = 4 }
		set_temp_variable = { _wt_railway_count = 0 }
		set_temp_variable = { _wt_prewar_count = 0 }

		for_each_loop = { array = WA_AI_PC_queue value = _wt_proj
			if = {
				limit = { check_variable = { WA_AI_PC_building_type^_wt_proj = 13 } }
				add_to_temp_variable = { _wt_railway_count = 1 }

				if = {
					limit = { check_variable = { WA_AI_PC_priority^_wt_proj = 5000 } }
					add_to_temp_variable = { _wt_prewar_count = 1 }
				}
			}
		}

		log = "[GetYear] [GetMonth] | TEST | [This.GetName] | RW TEST 004 CHECK: railway_count=[?_wt_railway_count] prewar_priority_count=[?_wt_prewar_count]"

		if = {
			limit = { check_variable = { _wt_railway_count = 0 } }
			# No railways yet - stay ONGOING
		}
		else_if = {
			limit = { check_variable = { _wt_prewar_count > 0 } }
			WA_TEST_RW_mark_passed = yes
		}
		else = {
			set_temp_variable = { _wt_fail_code = 3 }
			WA_TEST_RW_mark_failed = yes
		}
	}
}

############################################################################################################
#	TEST 005: Queue Data Integrity
#	Every railway project (type 13) must have valid data fields
#	Fail codes: 1=target_province 0, 2=connect_province 0, 3=target_state 0,
#	            4=project_cost<=0, 5=progress<=0, 6=priority<=0
############################################################################################################

WA_TEST_RW_005_launch = {
	set_temp_variable = { _wt_test_id = 5 }

	if = { limit = { check_variable = { WA_TEST_RW_state^5 = @WA_TEST_RW_PASSED } }
		log = "[GetYear] [GetMonth] | TEST | [This.GetName] | RW TEST 005: already PASSED, skipping re-launch"
	}
	else_if = { limit = { check_variable = { WA_TEST_RW_state^5 = @WA_TEST_RW_FAILED } }
		# Already resolved
	}
	else_if = { limit = { check_variable = { WA_TEST_RW_state^5 = @WA_TEST_RW_ONGOING } }
		# Already running
	}
	else_if = {
		limit = {
			OR = {
				has_war = yes
				AND = {
					num_of_civilian_factories > 75
					any_country = {
						exists = yes
						NOT = { tag = ROOT }
						NOT = { is_in_faction_with = ROOT }
						NOT = { is_subject_of = ROOT }
						OR = {
							ROOT = { is_justifying_wargoal_against = PREV }
							ROOT = { has_wargoal_against = PREV }
						}
						any_owned_state = {
							any_neighbor_state = {
								is_controlled_by = ROOT
								WA_AI_PC_state_has_supply_hub = yes
								NOT = { WA_AI_PC_state_has_railway_at_level_5 = yes }
							}
						}
					}
				}
			}
		}
		set_variable = { WA_TEST_RW_state^5 = @WA_TEST_RW_ONGOING }
		set_variable = { WA_TEST_RW_launch_day^5 = global.num_days }
		log = "[GetYear] [GetMonth] | TEST | [This.GetName] | RW TEST 005 (Queue Data Integrity): LAUNCHED (railway conditions active)"
	}
	else = {
		# No railway triggers active yet - stay NOT_LAUNCHED, will be re-attempted by checker
	}
}

WA_TEST_RW_005_check = {
	if = {
		limit = { check_variable = { WA_TEST_RW_state^5 = @WA_TEST_RW_ONGOING } }

		set_temp_variable = { _wt_test_id = 5 }
		set_temp_variable = { _wt_railway_count = 0 }
		set_temp_variable = { _wt_invalid_found = 0 }
		set_temp_variable = { _wt_invalid_code = 0 }

		for_each_loop = { array = WA_AI_PC_queue value = _wt_proj
			if = {
				limit = {
					check_variable = { WA_AI_PC_building_type^_wt_proj = 13 }
					check_variable = { _wt_invalid_found = 0 }
				}
				add_to_temp_variable = { _wt_railway_count = 1 }

				# Validate target_province
				if = {
					limit = { NOT = { check_variable = { WA_AI_PC_target_province^_wt_proj > 0 } } }
					set_temp_variable = { _wt_invalid_found = 1 }
					set_temp_variable = { _wt_invalid_code = 1 }
					log = "[GetYear] [GetMonth] | TEST | [This.GetName] | RW TEST 005: INVALID proj=[?_wt_proj] target_province=[?WA_AI_PC_target_province^_wt_proj]"
				}
				# Validate connect_province
				if = {
					limit = {
						check_variable = { _wt_invalid_found = 0 }
						NOT = { check_variable = { WA_AI_PC_connect_province^_wt_proj > 0 } }
					}
					set_temp_variable = { _wt_invalid_found = 1 }
					set_temp_variable = { _wt_invalid_code = 2 }
					log = "[GetYear] [GetMonth] | TEST | [This.GetName] | RW TEST 005: INVALID proj=[?_wt_proj] connect_province=[?WA_AI_PC_connect_province^_wt_proj]"
				}
				# Validate target_state
				if = {
					limit = {
						check_variable = { _wt_invalid_found = 0 }
						NOT = { check_variable = { WA_AI_PC_target_state^_wt_proj > 0 } }
					}
					set_temp_variable = { _wt_invalid_found = 1 }
					set_temp_variable = { _wt_invalid_code = 3 }
					log = "[GetYear] [GetMonth] | TEST | [This.GetName] | RW TEST 005: INVALID proj=[?_wt_proj] target_state=[?WA_AI_PC_target_state^_wt_proj]"
				}
				# Validate project_cost
				if = {
					limit = {
						check_variable = { _wt_invalid_found = 0 }
						NOT = { check_variable = { WA_AI_PC_project_cost^_wt_proj > 0 } }
					}
					set_temp_variable = { _wt_invalid_found = 1 }
					set_temp_variable = { _wt_invalid_code = 4 }
					log = "[GetYear] [GetMonth] | TEST | [This.GetName] | RW TEST 005: INVALID proj=[?_wt_proj] project_cost=[?WA_AI_PC_project_cost^_wt_proj]"
				}
				# Validate progress
				if = {
					limit = {
						check_variable = { _wt_invalid_found = 0 }
						NOT = { check_variable = { WA_AI_PC_progress^_wt_proj > 0 } }
					}
					set_temp_variable = { _wt_invalid_found = 1 }
					set_temp_variable = { _wt_invalid_code = 5 }
					log = "[GetYear] [GetMonth] | TEST | [This.GetName] | RW TEST 005: INVALID proj=[?_wt_proj] progress=[?WA_AI_PC_progress^_wt_proj]"
				}
				# Validate priority
				if = {
					limit = {
						check_variable = { _wt_invalid_found = 0 }
						NOT = { check_variable = { WA_AI_PC_priority^_wt_proj > 0 } }
					}
					set_temp_variable = { _wt_invalid_found = 1 }
					set_temp_variable = { _wt_invalid_code = 6 }
					log = "[GetYear] [GetMonth] | TEST | [This.GetName] | RW TEST 005: INVALID proj=[?_wt_proj] priority=[?WA_AI_PC_priority^_wt_proj]"
				}
			}
		}

		if = {
			limit = { check_variable = { _wt_railway_count = 0 } }
			# No railways to check yet - remain ONGOING
		}
		else_if = {
			limit = { check_variable = { _wt_invalid_found = 1 } }
			set_temp_variable = { _wt_fail_code = _wt_invalid_code }
			WA_TEST_RW_mark_failed = yes
		}
		else = {
			log = "[GetYear] [GetMonth] | TEST | [This.GetName] | RW TEST 005: Validated [?_wt_railway_count] railway projects - all fields valid"
			WA_TEST_RW_mark_passed = yes
		}
	}
}

############################################################################################################
#	TEST 006: Home Port Selection
#	Port upgrades should target a Japanese home island state (282, 528-536)
#	Fail codes: 1=no port projects, 2=port targets non-home-island state
############################################################################################################

WA_TEST_RW_006_launch = {
	set_temp_variable = { _wt_test_id = 6 }

	if = { limit = { check_variable = { WA_TEST_RW_state^6 = @WA_TEST_RW_PASSED } }
		log = "[GetYear] [GetMonth] | TEST | [This.GetName] | RW TEST 006: already PASSED, skipping re-launch"
	}
	else_if = { limit = { check_variable = { WA_TEST_RW_state^6 = @WA_TEST_RW_FAILED } }
		# Already resolved
	}
	else_if = { limit = { check_variable = { WA_TEST_RW_state^6 = @WA_TEST_RW_ONGOING } }
		# Already running
	}
	else_if = {
		limit = { has_war = yes }
		set_variable = { WA_TEST_RW_state^6 = @WA_TEST_RW_ONGOING }
		set_variable = { WA_TEST_RW_launch_day^6 = global.num_days }
		log = "[GetYear] [GetMonth] | TEST | [This.GetName] | RW TEST 006 (Home Port Selection): LAUNCHED (war started)"
	}
	else = {
		# Not at war yet - stay NOT_LAUNCHED, will be re-attempted by checker
	}
}

WA_TEST_RW_006_check = {
	if = {
		limit = { check_variable = { WA_TEST_RW_state^6 = @WA_TEST_RW_ONGOING } }

		set_temp_variable = { _wt_test_id = 6 }
		set_temp_variable = { _wt_port_count = 0 }
		set_temp_variable = { _wt_home_island_port = 0 }
		set_temp_variable = { _wt_non_home_port = 0 }

		for_each_loop = { array = WA_AI_PC_queue value = _wt_proj
			if = {
				limit = { check_variable = { WA_AI_PC_building_type^_wt_proj = 14 } }
				add_to_temp_variable = { _wt_port_count = 1 }

				set_temp_variable = { _wt_pstate = WA_AI_PC_target_state^_wt_proj }
				if = {
					limit = {
						OR = {
							check_variable = { _wt_pstate = 282 }
							check_variable = { _wt_pstate = 528 }
							check_variable = { _wt_pstate = 529 }
							check_variable = { _wt_pstate = 530 }
							check_variable = { _wt_pstate = 531 }
							check_variable = { _wt_pstate = 532 }
							check_variable = { _wt_pstate = 533 }
							check_variable = { _wt_pstate = 534 }
							check_variable = { _wt_pstate = 535 }
							check_variable = { _wt_pstate = 536 }
						}
					}
					set_temp_variable = { _wt_home_island_port = 1 }
				}
				else = {
					set_temp_variable = { _wt_non_home_port = 1 }
				}
			}
		}

		log = "[GetYear] [GetMonth] | TEST | [This.GetName] | RW TEST 006 CHECK: port_count=[?_wt_port_count] home_island=[?_wt_home_island_port] non_home=[?_wt_non_home_port]"

		if = {
			limit = { check_variable = { _wt_port_count = 0 } }
			# No port projects yet - stay ONGOING
		}
		else_if = {
			limit = { check_variable = { _wt_home_island_port = 1 } }
			WA_TEST_RW_mark_passed = yes
		}
		else = {
			set_temp_variable = { _wt_fail_code = 2 }
			WA_TEST_RW_mark_failed = yes
		}
	}
}

############################################################################################################
#	TEST 007: Supply Chain Analysis for Overseas Territory
#	Directly call WA_AI_PC_analyze_overseas_supply_chain and validate output
#	Fail codes: 1=route_start=0, 2=max_level=0, 3=max_level>5, 4=receiving_port_state=0,
#	            5=landmass data invalid
############################################################################################################

WA_TEST_RW_007_launch = {
	set_temp_variable = { _wt_test_id = 7 }

	if = { limit = { check_variable = { WA_TEST_RW_state^7 = @WA_TEST_RW_PASSED } }
		log = "[GetYear] [GetMonth] | TEST | [This.GetName] | RW TEST 007: already PASSED, skipping re-launch"
	}
	else = {
		set_variable = { WA_TEST_RW_state^7 = @WA_TEST_RW_ONGOING }
		set_variable = { WA_TEST_RW_launch_day^7 = global.num_days }
		log = "[GetYear] [GetMonth] | TEST | [This.GetName] | RW TEST 007 (Supply Chain Analysis): LAUNCHED"
	}
}

WA_TEST_RW_007_check = {
	if = {
		limit = { check_variable = { WA_TEST_RW_state^7 = @WA_TEST_RW_ONGOING } }

		set_temp_variable = { _wt_test_id = 7 }

		# Get capital info
		WA_AI_MAP_get_capital_vp_province = yes
		set_temp_variable = { capital_province = capital_vp_province_ }
		set_temp_variable = { capital_state_id = capital_state_id_ }
		set_temp_variable = { capital_landmass = global.WA_AI_MAP_state_landmass^capital_state_id }

		# Korea (state 525) is on the Asian mainland - use its landmass as target
		set_temp_variable = { target_landmass = global.WA_AI_MAP_state_landmass^525 }

		log = "[GetYear] [GetMonth] | TEST | [This.GetName] | RW TEST 007: capital_landmass=[?capital_landmass] target_landmass(Korea 525)=[?target_landmass]"

		# Proceed only if both landmasses are known and different
		if = {
			limit = {
				check_variable = { capital_landmass > 0 }
				check_variable = { target_landmass > 0 }
				NOT = { check_variable = { capital_landmass = target_landmass } }
			}

			# Call the supply chain analyzer
			WA_AI_PC_analyze_overseas_supply_chain = yes

			log = "[GetYear] [GetMonth] | TEST | [This.GetName] | RW TEST 007: route_start=[?overseas_route_start_] max_level=[?overseas_max_railway_level_] port_state=[?overseas_receiving_port_state_]"

			# Assertion 1: route_start > 0
			if = {
				limit = { NOT = { check_variable = { overseas_route_start_ > 0 } } }
				set_temp_variable = { _wt_fail_code = 1 }
				WA_TEST_RW_mark_failed = yes
			}
			# Assertion 2: max_railway_level > 0
			else_if = {
				limit = { NOT = { check_variable = { overseas_max_railway_level_ > 0 } } }
				set_temp_variable = { _wt_fail_code = 2 }
				WA_TEST_RW_mark_failed = yes
			}
			# Assertion 3: max_railway_level <= 5
			else_if = {
				limit = { check_variable = { overseas_max_railway_level_ > 5 } }
				set_temp_variable = { _wt_fail_code = 3 }
				WA_TEST_RW_mark_failed = yes
			}
			# Assertion 4: receiving_port_state > 0
			else_if = {
				limit = { NOT = { check_variable = { overseas_receiving_port_state_ > 0 } } }
				set_temp_variable = { _wt_fail_code = 4 }
				WA_TEST_RW_mark_failed = yes
			}
			else = {
				WA_TEST_RW_mark_passed = yes
			}
		}
		else = {
			set_temp_variable = { _wt_fail_code = 5 }
			WA_TEST_RW_mark_failed = yes
			log = "[GetYear] [GetMonth] | TEST | [This.GetName] | RW TEST 007: FAIL - landmass data invalid or same"
		}
	}
}

############################################################################################################
#	TEST 008: Single-Node State Detection
#	State 1053 (Ryukyu) should be single_node=1, State 528 (Kyushu) should be single_node=0
#	Fail codes: 1=state 1053 not detected as single_node, 2=state 528 incorrectly detected
############################################################################################################

WA_TEST_RW_008_launch = {
	set_temp_variable = { _wt_test_id = 8 }

	if = { limit = { check_variable = { WA_TEST_RW_state^8 = @WA_TEST_RW_PASSED } }
		log = "[GetYear] [GetMonth] | TEST | [This.GetName] | RW TEST 008: already PASSED, skipping re-launch"
	}
	else_if = {
		limit = {
			NOT = {
				AND = {
					1053 = { is_controlled_by = PREV }
					528 = { is_controlled_by = PREV }
				}
			}
		}
		WA_TEST_RW_mark_skipped = yes
	}
	else = {
		set_variable = { WA_TEST_RW_state^8 = @WA_TEST_RW_ONGOING }
		set_variable = { WA_TEST_RW_launch_day^8 = global.num_days }
		log = "[GetYear] [GetMonth] | TEST | [This.GetName] | RW TEST 008 (Single-Node Detection): LAUNCHED"
	}
}

WA_TEST_RW_008_check = {
	if = {
		limit = { check_variable = { WA_TEST_RW_state^8 = @WA_TEST_RW_ONGOING } }

		set_temp_variable = { _wt_test_id = 8 }

		# Assertion 1: State 1053 (Ryukyu) IS a single-node state
		1053 = { WA_AI_PC_coastal_state_is_single_node = yes }
		set_temp_variable = { _wt_ryukyu_result = is_single_node_ }

		# Assertion 2: State 528 (Kyushu) is NOT a single-node state
		528 = { WA_AI_PC_coastal_state_is_single_node = yes }
		set_temp_variable = { _wt_kyushu_result = is_single_node_ }

		log = "[GetYear] [GetMonth] | TEST | [This.GetName] | RW TEST 008: ryukyu(1053)=[?_wt_ryukyu_result] kyushu(528)=[?_wt_kyushu_result]"

		if = {
			limit = { check_variable = { _wt_ryukyu_result = 0 } }
			set_temp_variable = { _wt_fail_code = 1 }
			WA_TEST_RW_mark_failed = yes
		}
		else_if = {
			limit = { check_variable = { _wt_kyushu_result = 1 } }
			set_temp_variable = { _wt_fail_code = 2 }
			WA_TEST_RW_mark_failed = yes
		}
		else = {
			WA_TEST_RW_mark_passed = yes
		}
	}
}

############################################################################################################
#	TEST 009: Capital Home Port Railway (Wartime)
#	When at war, capital state should queue railway to its naval base (capital -> naval base)
#	For Japan: Tokyo (prov 1182) -> Yokohama (prov 9998) in Kanto state (282)
#	Fail codes: 1=not at war, 2=no railways queued, 3=no Kanto target, 4=wrong route, 5=wrong level
############################################################################################################

WA_TEST_RW_009_launch = {
	set_temp_variable = { _wt_test_id = 9 }

	if = { limit = { check_variable = { WA_TEST_RW_state^9 = @WA_TEST_RW_PASSED } }
		log = "[GetYear] [GetMonth] | TEST | [This.GetName] | RW TEST 009: already PASSED, skipping re-launch"
	}
	else_if = { limit = { check_variable = { WA_TEST_RW_state^9 = @WA_TEST_RW_FAILED } }
		# Already resolved
	}
	else_if = { limit = { check_variable = { WA_TEST_RW_state^9 = @WA_TEST_RW_ONGOING } }
		# Already running
	}
	else_if = {
		limit = { has_war = yes }
		set_variable = { WA_TEST_RW_state^9 = @WA_TEST_RW_ONGOING }
		set_variable = { WA_TEST_RW_launch_day^9 = global.num_days }
		log = "[GetYear] [GetMonth] | TEST | [This.GetName] | RW TEST 009 (Capital Home Port War): LAUNCHED (war started)"
	}
	else = {
		# Not at war yet - stay NOT_LAUNCHED, will be re-attempted by checker
	}
}

WA_TEST_RW_009_check = {
	if = {
		limit = { check_variable = { WA_TEST_RW_state^9 = @WA_TEST_RW_ONGOING } }

		set_temp_variable = { _wt_test_id = 9 }
		set_temp_variable = { _wt_railway_count = 0 }
		set_temp_variable = { _wt_kanto_found = 0 }
		set_temp_variable = { _wt_capital_province = 1182 }
		set_temp_variable = { _wt_naval_base_province = 9998 }

		for_each_loop = { array = WA_AI_PC_queue value = _wt_proj
			if = {
				limit = { check_variable = { WA_AI_PC_building_type^_wt_proj = 13 } }
				add_to_temp_variable = { _wt_railway_count = 1 }

				# Check if this project targets Kanto (state 282)
				set_temp_variable = { _wt_proj_state = WA_AI_PC_target_state^_wt_proj }
				if = {
					limit = { check_variable = { _wt_proj_state = 282 } }
					# Found Kanto target - check routing
					set_temp_variable = { _wt_proj_start = WA_AI_PC_target_province^_wt_proj }
					set_temp_variable = { _wt_proj_end = WA_AI_PC_connect_province^_wt_proj }
					set_temp_variable = { _wt_proj_level = WA_AI_PC_target_level^_wt_proj }

					if = {
						limit = {
							check_variable = { _wt_proj_start = _wt_capital_province }
							check_variable = { _wt_proj_end = _wt_naval_base_province }
							check_variable = { _wt_proj_level = 5 }
						}
						# Perfect match!
						set_temp_variable = { _wt_kanto_found = 1 }
					}
				}
			}
		}

		log = "[GetYear] [GetMonth] | TEST | [This.GetName] | RW TEST 009 CHECK: railway_count=[?_wt_railway_count] kanto_valid=[?_wt_kanto_found]"

		if = {
			limit = { check_variable = { _wt_railway_count = 0 } }
			# No railways yet - remain ONGOING (system might not have run yet)
		}
		else_if = {
			limit = { check_variable = { _wt_kanto_found = 1 } }
			WA_TEST_RW_mark_passed = yes
		}
		else = {
			# Railways exist but Kanto not found with correct routing
			set_temp_variable = { _wt_fail_code = 3 }
			WA_TEST_RW_mark_failed = yes
		}
	}
}

############################################################################################################
#	TEST 010: Dalian Port Level (1939 Check)
#	By 1939, Dalian (state 745) naval base should be at max level (>=7)
#	Validates overseas supply chain port upgrades work correctly
#	Date-gated: stays NOT_LAUNCHED until 1939
#	Fail codes: 1=no naval base found in state 745, 2=naval base level < 7
############################################################################################################

WA_TEST_RW_010_launch = {
	set_temp_variable = { _wt_test_id = 10 }

	if = { limit = { check_variable = { WA_TEST_RW_state^10 = @WA_TEST_RW_PASSED } }
		log = "[GetYear] [GetMonth] | TEST | [This.GetName] | RW TEST 010: already PASSED, skipping re-launch"
	}
	else_if = { limit = { check_variable = { WA_TEST_RW_state^10 = @WA_TEST_RW_FAILED } }
		# Already resolved
	}
	else_if = { limit = { check_variable = { WA_TEST_RW_state^10 = @WA_TEST_RW_ONGOING } }
		# Already running
	}
	else_if = {
		limit = { date > 1938.12.31 }
		set_variable = { WA_TEST_RW_state^10 = @WA_TEST_RW_ONGOING }
		set_variable = { WA_TEST_RW_launch_day^10 = global.num_days }
		log = "[GetYear] [GetMonth] | TEST | [This.GetName] | RW TEST 010 (Dalian Port Level): LAUNCHED (date >= 1939)"
	}
	else = {
		# Not 1939 yet - stay NOT_LAUNCHED, will be re-attempted by checker
	}
}

WA_TEST_RW_010_check = {
	if = {
		limit = { check_variable = { WA_TEST_RW_state^10 = @WA_TEST_RW_ONGOING } }

		set_temp_variable = { _wt_test_id = 10 }

		# Get Dalian's naval base province and level
		745 = { WA_AI_PC_railway_get_naval_base_province = yes }

		log = "[GetYear] [GetMonth] | TEST | [This.GetName] | RW TEST 010 CHECK: naval_base_province=[?naval_base_province_] naval_base_level=[?naval_base_level_]"

		if = {
			limit = { NOT = { check_variable = { naval_base_province_ > 0 } } }
			set_temp_variable = { _wt_fail_code = 1 }
			WA_TEST_RW_mark_failed = yes
			log = "[GetYear] [GetMonth] | TEST | [This.GetName] | RW TEST 010: FAIL - no naval base found in state 745 (Dalian)"
		}
		else_if = {
			limit = { NOT = { check_variable = { naval_base_level_ > 6 } } }
			set_temp_variable = { _wt_fail_code = 2 }
			WA_TEST_RW_mark_failed = yes
			log = "[GetYear] [GetMonth] | TEST | [This.GetName] | RW TEST 010: FAIL - naval base level [?naval_base_level_] < 7"
		}
		else = {
			WA_TEST_RW_mark_passed = yes
		}
	}
}

############################################################################################################
#	TEST 011: DalianBeijing/Tianjin Railway (1939 Check)
#	By 1939, complete railway at level 5 should exist from Dalian through Manchukuo
#	Route: Dalian (745)  Liaotung (716)  Tangshan (609)  Beijing (608) / Tianjin (949)
#	Validates cross-border pathfinder fix (subject scope addition)
#	Date-gated: stays NOT_LAUNCHED until 1939
#	Fail codes: 1=state 745 no lvl5, 2=state 716 no lvl5, 3=state 609 no lvl5,
#	            4=neither state 608 nor 949 has lvl5
############################################################################################################

WA_TEST_RW_011_launch = {
	set_temp_variable = { _wt_test_id = 11 }

	if = { limit = { check_variable = { WA_TEST_RW_state^11 = @WA_TEST_RW_PASSED } }
		log = "[GetYear] [GetMonth] | TEST | [This.GetName] | RW TEST 011: already PASSED, skipping re-launch"
	}
	else_if = { limit = { check_variable = { WA_TEST_RW_state^11 = @WA_TEST_RW_FAILED } }
		# Already resolved
	}
	else_if = { limit = { check_variable = { WA_TEST_RW_state^11 = @WA_TEST_RW_ONGOING } }
		# Already running
	}
	else_if = {
		limit = { date > 1938.12.31 }
		set_variable = { WA_TEST_RW_state^11 = @WA_TEST_RW_ONGOING }
		set_variable = { WA_TEST_RW_launch_day^11 = global.num_days }
		log = "[GetYear] [GetMonth] | TEST | [This.GetName] | RW TEST 011 (Dalian-Beijing Railway): LAUNCHED (date >= 1939)"
	}
	else = {
		# Not 1939 yet - stay NOT_LAUNCHED, will be re-attempted by checker
	}
}

WA_TEST_RW_011_check = {
	if = {
		limit = { check_variable = { WA_TEST_RW_state^11 = @WA_TEST_RW_ONGOING } }

		set_temp_variable = { _wt_test_id = 11 }

		# Check railway level 5 on each state along the route
		set_temp_variable = { _wt_745_ok = 0 }
		set_temp_variable = { _wt_716_ok = 0 }
		set_temp_variable = { _wt_609_ok = 0 }
		set_temp_variable = { _wt_end_ok = 0 }

		# State 745 (Dalian - Japan)
		if = {
			limit = { 745 = { WA_AI_PC_state_has_railway_at_level_5 = yes } }
			set_temp_variable = { _wt_745_ok = 1 }
		}

		# State 716 (Liaotung - Manchukuo) - the cross-border state
		if = {
			limit = { 716 = { WA_AI_PC_state_has_railway_at_level_5 = yes } }
			set_temp_variable = { _wt_716_ok = 1 }
		}

		# State 609 (Tangshan - Japan)
		if = {
			limit = { 609 = { WA_AI_PC_state_has_railway_at_level_5 = yes } }
			set_temp_variable = { _wt_609_ok = 1 }
		}

		# State 608 (Beijing) OR State 949 (Tianjin) - at least one must have level 5
		if = {
			limit = {
				OR = {
					608 = { WA_AI_PC_state_has_railway_at_level_5 = yes }
					949 = { WA_AI_PC_state_has_railway_at_level_5 = yes }
				}
			}
			set_temp_variable = { _wt_end_ok = 1 }
		}

		log = "[GetYear] [GetMonth] | TEST | [This.GetName] | RW TEST 011 CHECK: 745=[?_wt_745_ok] 716=[?_wt_716_ok] 609=[?_wt_609_ok] end(608/949)=[?_wt_end_ok]"

		# Evaluate results
		if = {
			limit = { check_variable = { _wt_745_ok = 0 } }
			set_temp_variable = { _wt_fail_code = 1 }
			WA_TEST_RW_mark_failed = yes
			log = "[GetYear] [GetMonth] | TEST | [This.GetName] | RW TEST 011: FAIL - state 745 (Dalian) missing level 5 railway"
		}
		else_if = {
			limit = { check_variable = { _wt_716_ok = 0 } }
			set_temp_variable = { _wt_fail_code = 2 }
			WA_TEST_RW_mark_failed = yes
			log = "[GetYear] [GetMonth] | TEST | [This.GetName] | RW TEST 011: FAIL - state 716 (Liaotung/Manchukuo) missing level 5 railway"
		}
		else_if = {
			limit = { check_variable = { _wt_609_ok = 0 } }
			set_temp_variable = { _wt_fail_code = 3 }
			WA_TEST_RW_mark_failed = yes
			log = "[GetYear] [GetMonth] | TEST | [This.GetName] | RW TEST 011: FAIL - state 609 (Tangshan) missing level 5 railway"
		}
		else_if = {
			limit = { check_variable = { _wt_end_ok = 0 } }
			set_temp_variable = { _wt_fail_code = 4 }
			WA_TEST_RW_mark_failed = yes
			log = "[GetYear] [GetMonth] | TEST | [This.GetName] | RW TEST 011: FAIL - neither state 608 (Beijing) nor 949 (Tianjin) has level 5 railway"
		}
		else = {
			WA_TEST_RW_mark_passed = yes
		}
	}
}
