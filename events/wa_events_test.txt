add_namespace = wa_test

############################################################################################################
#	Railway Test Suite - Periodic Checker Event
#	Fires on country scope after suite launch, re-fires every 28 days until all tests resolve
############################################################################################################

country_event = {
	id = wa_test.100

	hidden = yes
	is_triggered_only = yes

	immediate = {
		if = {
			limit = { has_country_flag = WA_TEST_RW_suite_active }

			log = "[GetYear] [GetMonth] | TEST | [This.GetName] | RW CHECKER: Evaluating tests..."

			# Re-attempt deferred launches (tests that wait for preconditions)
			WA_TEST_RW_001_launch = yes
			WA_TEST_RW_002_launch = yes
			WA_TEST_RW_004_launch = yes
			WA_TEST_RW_005_launch = yes
			WA_TEST_RW_006_launch = yes
			WA_TEST_RW_010_launch = yes
			WA_TEST_RW_011_launch = yes
			WA_TEST_RW_012_launch = yes
			WA_TEST_RW_013_launch = yes

			# Run all test checks
			WA_TEST_RW_check_all = yes

			# Count ongoing tests
			set_temp_variable = { _wt_still_ongoing = 0 }
			if = { limit = { check_variable = { WA_TEST_RW_state^1 = 1 } } add_to_temp_variable = { _wt_still_ongoing = 1 } }
			if = { limit = { check_variable = { WA_TEST_RW_state^2 = 1 } } add_to_temp_variable = { _wt_still_ongoing = 1 } }
			if = { limit = { check_variable = { WA_TEST_RW_state^3 = 1 } } add_to_temp_variable = { _wt_still_ongoing = 1 } }
			if = { limit = { check_variable = { WA_TEST_RW_state^4 = 1 } } add_to_temp_variable = { _wt_still_ongoing = 1 } }
			if = { limit = { check_variable = { WA_TEST_RW_state^5 = 1 } } add_to_temp_variable = { _wt_still_ongoing = 1 } }
			if = { limit = { check_variable = { WA_TEST_RW_state^6 = 1 } } add_to_temp_variable = { _wt_still_ongoing = 1 } }
			if = { limit = { check_variable = { WA_TEST_RW_state^7 = 1 } } add_to_temp_variable = { _wt_still_ongoing = 1 } }
			if = { limit = { check_variable = { WA_TEST_RW_state^8 = 1 } } add_to_temp_variable = { _wt_still_ongoing = 1 } }
			if = { limit = { check_variable = { WA_TEST_RW_state^9 = 1 } } add_to_temp_variable = { _wt_still_ongoing = 1 } }
			if = { limit = { check_variable = { WA_TEST_RW_state^10 = 1 } } add_to_temp_variable = { _wt_still_ongoing = 1 } }
			if = { limit = { check_variable = { WA_TEST_RW_state^11 = 1 } } add_to_temp_variable = { _wt_still_ongoing = 1 } }
			if = { limit = { check_variable = { WA_TEST_RW_state^12 = 1 } } add_to_temp_variable = { _wt_still_ongoing = 1 } }
			if = { limit = { check_variable = { WA_TEST_RW_state^13 = 1 } } add_to_temp_variable = { _wt_still_ongoing = 1 } }

			# Count NOT_LAUNCHED tests (deferred, waiting for preconditions)
			set_temp_variable = { _wt_still_waiting = 0 }
			if = { limit = { check_variable = { WA_TEST_RW_state^1 = 0 } } add_to_temp_variable = { _wt_still_waiting = 1 } }
			if = { limit = { check_variable = { WA_TEST_RW_state^2 = 0 } } add_to_temp_variable = { _wt_still_waiting = 1 } }
			if = { limit = { check_variable = { WA_TEST_RW_state^3 = 0 } } add_to_temp_variable = { _wt_still_waiting = 1 } }
			if = { limit = { check_variable = { WA_TEST_RW_state^4 = 0 } } add_to_temp_variable = { _wt_still_waiting = 1 } }
			if = { limit = { check_variable = { WA_TEST_RW_state^5 = 0 } } add_to_temp_variable = { _wt_still_waiting = 1 } }
			if = { limit = { check_variable = { WA_TEST_RW_state^6 = 0 } } add_to_temp_variable = { _wt_still_waiting = 1 } }
			if = { limit = { check_variable = { WA_TEST_RW_state^7 = 0 } } add_to_temp_variable = { _wt_still_waiting = 1 } }
			if = { limit = { check_variable = { WA_TEST_RW_state^8 = 0 } } add_to_temp_variable = { _wt_still_waiting = 1 } }
			if = { limit = { check_variable = { WA_TEST_RW_state^9 = 0 } } add_to_temp_variable = { _wt_still_waiting = 1 } }
			if = { limit = { check_variable = { WA_TEST_RW_state^10 = 0 } } add_to_temp_variable = { _wt_still_waiting = 1 } }
			if = { limit = { check_variable = { WA_TEST_RW_state^11 = 0 } } add_to_temp_variable = { _wt_still_waiting = 1 } }
			if = { limit = { check_variable = { WA_TEST_RW_state^12 = 0 } } add_to_temp_variable = { _wt_still_waiting = 1 } }
			if = { limit = { check_variable = { WA_TEST_RW_state^13 = 0 } } add_to_temp_variable = { _wt_still_waiting = 1 } }

			set_temp_variable = { _wt_unresolved = _wt_still_ongoing }
			add_to_temp_variable = { _wt_unresolved = _wt_still_waiting }

			WA_TEST_RW_log_summary = yes

			if = {
				limit = { check_variable = { _wt_unresolved > 0 } }
				# Re-schedule checker in 28 days
				country_event = { id = wa_test.100 days = 28 }
				log = "[GetYear] [GetMonth] | TEST | [This.GetName] | RW CHECKER: [?_wt_still_ongoing] tests ongoing, [?_wt_still_waiting] waiting, re-checking in 28 days"
			}
			else = {
				# All tests resolved
				clr_country_flag = WA_TEST_RW_suite_active
				log = "[GetYear] [GetMonth] | TEST | [This.GetName] | ================================================"
				log = "[GetYear] [GetMonth] | TEST | [This.GetName] | RAILWAY SUITE COMPLETE - All tests resolved"
				log = "[GetYear] [GetMonth] | TEST | [This.GetName] | ================================================"
				WA_TEST_RW_print = yes
			}
		}
	}

	option = {}
}

############################################################################################################
#	Spirit Test Suite - Periodic Checker Event
#	Fires per-country after suite launch, re-fires every 28 days until test resolves
############################################################################################################

country_event = {
	id = wa_test.200

	hidden = yes
	is_triggered_only = yes

	immediate = {
		if = {
			limit = { has_country_flag = WA_TEST_SP_suite_active }

			log = "[GetYear] [GetMonth] | TEST | [This.GetName] | SP CHECKER: Evaluating..."

			# Re-attempt launch (date gate)
			WA_TEST_SP_launch_for_country = yes

			# Run check
			WA_TEST_SP_check_for_country = yes

			# Count unresolved (slot 1 only per country)
			set_temp_variable = { _wt_unresolved = 0 }
			if = { limit = { check_variable = { WA_TEST_SP_state^1 = 1 } } set_temp_variable = { _wt_unresolved = 1 } }
			if = { limit = { check_variable = { WA_TEST_SP_state^1 = 0 } } set_temp_variable = { _wt_unresolved = 1 } }

			if = {
				limit = { check_variable = { _wt_unresolved > 0 } }
				country_event = { id = wa_test.200 days = 28 }
				log = "[GetYear] [GetMonth] | TEST | [This.GetName] | SP CHECKER: Test still unresolved, re-checking in 28 days"
			}
			else = {
				clr_country_flag = WA_TEST_SP_suite_active
				log = "[GetYear] [GetMonth] | TEST | [This.GetName] | ================================================"
				log = "[GetYear] [GetMonth] | TEST | [This.GetName] | SPIRIT SUITE COMPLETE for [This.GetName]"
				log = "[GetYear] [GetMonth] | TEST | [This.GetName] | ================================================"
			}
		}
	}

	option = {}
}
